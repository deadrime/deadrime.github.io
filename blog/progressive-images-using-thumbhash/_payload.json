[{"data":1,"prerenderedAt":2796},["ShallowReactive",2],{"post_/blog/progressive-images-using-thumbhash":3,"surround/blog/progressive-images-using-thumbhash":2787},{"id":4,"title":5,"body":6,"date":2774,"description":2775,"extension":2776,"meta":2777,"navigation":126,"path":2778,"previewImg":2779,"seo":2780,"stem":2781,"topics":2782,"__hash__":2786},"articles/blog/progressive-images-using-thumbhash.md","Progressive images при помощи base64 миниатюр",{"type":7,"value":8,"toc":2766},"minimark",[9,14,18,30,33,40,48,51,57,60,66,75,79,82,89,664,667,672,781,787,968,982,993,1287,1290,1301,1304,1329,1332,1402,1405,1510,1513,1795,1799,1810,2061,2066,2073,2419,2423,2429,2762],[10,11,13],"h2",{"id":12},"why","Зачем оно вообще нужно",[15,16,17],"p",{},"Для начала поговорим про цифры. Если вы когда-нибудь делали аналитику сайта - то вы в курсе, что изображения весьма прожорливые. Скорее всего даже более прожорливые, чем ваш бандл.\nПеред тем, как пытаться оптимизировать что-либо еще - лучше начать именно с картинок.",[15,19,20,21,25,26,29],{},"Однако даже если использовать ",[22,23,24],"code",{},"WEBP"," или ",[22,27,28],{},"AVIF"," - картинки все равно будут весить неприлично много.\nОсобенно если их много.\nПри этом всегда стоит держать в голове, что среднестатистический пользователь вашего сайта скорее всего зайдет с мобильного телефона.\nИ у него вряд ли будет быстрый мобильный интернет. А медленный интернет накладывает свои ограничения:",[15,31,32],{},"UI может прыгать, пока все картинки не загрузятся (сделаем допущение, что вы не хотите или не можете привести все картинки к одному размеру)\nПри медленном интернете или если сервер слишком далеко от пользователя, он будет видеть огрызки картинок, что прямо скажем не красиво.",[15,34,35],{},[36,37],"img",{"alt":38,"src":39},"Раздражает, правда?","https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNXJtZTh4dGJ2bDBiMnVuZHJkMmc2cWQxZzFkdGdzOXJxYjdhbGYzbSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/QIQTfximd3AuQ/giphy.gif",[15,41,42,43,47],{},"А еще пользователь у нас очень привередливый и если мы не покажем ему хоть что-то в течении первых пары секунд - скорее всего мы его потеряем.\nИменно проблему ",[44,45,46],"strong",{},"показать хоть что-то"," и призвана решить прогрессивная загрузка изображений.",[15,49,50],{},"Идея заключается в том, что мы показываем пользователю миниатюру в низком разрешении, пока грузим оригинальную картинку.",[15,52,53],{},[36,54],{"alt":55,"src":56},"Пример из telegram","/images/progressive-images-using-thumbhash/telegram-example.png",[15,58,59],{},"Для реализации такого подхода я выбрал либу thumbhash, она весит \u003C 4kb и позволяет хранить хеш весом всего 30-40 байт.",[61,62],"code-example",{"height":63,"open-file":64,"project-id":65},600,"ProgressiveImageExample.tsx","react-ts-c9v55cdz",[15,67,68,69],{},"Еще примеры можно найти на официальном сайте: ",[70,71,72],"a",{"href":72,"rel":73},"https://evanw.github.io/thumbhash/",[74],"nofollow",[10,76,78],{"id":77},"generate-thumbhash-on-client-side","Генерация thumbhash на клиенте",[15,80,81],{},"Рассмотрим кейс, когда пользователь создает новый пост и сам загружает изображение. В этом случае сгенерировать thumb можно прямо на клиенте.",[15,83,84,85,88],{},"Для начала загрузка изображения - тут все стандартно, подписываемся на ",[22,86,87],{},"onChange"," у инпута и достаем оттуда файл",[90,91,96],"pre",{"className":92,"code":93,"language":94,"meta":95,"style":95},"language-tsx shiki shiki-themes github-light github-dark","import { useCallback, useState } from \"react\";\n\nconst loadImage = (imageUrl: string) => {\n  return new Promise\u003CHTMLImageElement>((resolve) => {\n    const img = new Image();\n\n    img.src = imageUrl;\n\n    img.onload = () => {\n      resolve(img);\n    };\n  });\n};\n\nconst getImageUrl = (file: File) => {\n  // You can implement your own upload logic here\n  // For example we just create url on client-side\n  const url = URL.createObjectURL(file); \n  return url;\n};\n\nexport default function App() {\n  const [originalImageSrc, setOriginalImageSrc] = useState(\"\");\n\n  const handleFileUpload = useCallback(\n    async (event: React.ChangeEvent\u003CHTMLInputElement>) => {\n      if (!event.target.files?.length) {\n        return;\n      }\n      const file = event.target.files[0];\n      const url = await getImageUrl(file);\n      setOriginalImageSrc(url);\n    },\n    []\n  );\n\n  return (\n    \u003Cdiv className=\"App\">\n      \u003Cinput type=\"file\" onChange={handleFileUpload} />\n      \u003Cimg src={originalImageSrc} />\n    \u003C/div>\n  );\n}\n","tsx","",[22,97,98,121,128,164,194,213,218,230,235,253,262,268,274,280,285,311,318,324,347,355,360,365,383,417,422,438,471,491,499,505,525,542,551,557,563,569,574,582,603,628,643,653,658],{"__ignoreMap":95},[99,100,103,107,111,114,118],"span",{"class":101,"line":102},"line",1,[99,104,106],{"class":105},"szBVR","import",[99,108,110],{"class":109},"sVt8B"," { useCallback, useState } ",[99,112,113],{"class":105},"from",[99,115,117],{"class":116},"sZZnC"," \"react\"",[99,119,120],{"class":109},";\n",[99,122,124],{"class":101,"line":123},2,[99,125,127],{"emptyLinePlaceholder":126},true,"\n",[99,129,131,134,138,141,144,148,151,155,158,161],{"class":101,"line":130},3,[99,132,133],{"class":105},"const",[99,135,137],{"class":136},"sScJk"," loadImage",[99,139,140],{"class":105}," =",[99,142,143],{"class":109}," (",[99,145,147],{"class":146},"s4XuR","imageUrl",[99,149,150],{"class":105},":",[99,152,154],{"class":153},"sj4cs"," string",[99,156,157],{"class":109},") ",[99,159,160],{"class":105},"=>",[99,162,163],{"class":109}," {\n",[99,165,167,170,173,176,179,182,185,188,190,192],{"class":101,"line":166},4,[99,168,169],{"class":105},"  return",[99,171,172],{"class":105}," new",[99,174,175],{"class":153}," Promise",[99,177,178],{"class":109},"\u003C",[99,180,181],{"class":136},"HTMLImageElement",[99,183,184],{"class":109},">((",[99,186,187],{"class":146},"resolve",[99,189,157],{"class":109},[99,191,160],{"class":105},[99,193,163],{"class":109},[99,195,197,200,203,205,207,210],{"class":101,"line":196},5,[99,198,199],{"class":105},"    const",[99,201,202],{"class":153}," img",[99,204,140],{"class":105},[99,206,172],{"class":105},[99,208,209],{"class":136}," Image",[99,211,212],{"class":109},"();\n",[99,214,216],{"class":101,"line":215},6,[99,217,127],{"emptyLinePlaceholder":126},[99,219,221,224,227],{"class":101,"line":220},7,[99,222,223],{"class":109},"    img.src ",[99,225,226],{"class":105},"=",[99,228,229],{"class":109}," imageUrl;\n",[99,231,233],{"class":101,"line":232},8,[99,234,127],{"emptyLinePlaceholder":126},[99,236,238,241,244,246,249,251],{"class":101,"line":237},9,[99,239,240],{"class":109},"    img.",[99,242,243],{"class":136},"onload",[99,245,140],{"class":105},[99,247,248],{"class":109}," () ",[99,250,160],{"class":105},[99,252,163],{"class":109},[99,254,256,259],{"class":101,"line":255},10,[99,257,258],{"class":136},"      resolve",[99,260,261],{"class":109},"(img);\n",[99,263,265],{"class":101,"line":264},11,[99,266,267],{"class":109},"    };\n",[99,269,271],{"class":101,"line":270},12,[99,272,273],{"class":109},"  });\n",[99,275,277],{"class":101,"line":276},13,[99,278,279],{"class":109},"};\n",[99,281,283],{"class":101,"line":282},14,[99,284,127],{"emptyLinePlaceholder":126},[99,286,288,290,293,295,297,300,302,305,307,309],{"class":101,"line":287},15,[99,289,133],{"class":105},[99,291,292],{"class":136}," getImageUrl",[99,294,140],{"class":105},[99,296,143],{"class":109},[99,298,299],{"class":146},"file",[99,301,150],{"class":105},[99,303,304],{"class":136}," File",[99,306,157],{"class":109},[99,308,160],{"class":105},[99,310,163],{"class":109},[99,312,314],{"class":101,"line":313},16,[99,315,317],{"class":316},"sJ8bj","  // You can implement your own upload logic here\n",[99,319,321],{"class":101,"line":320},17,[99,322,323],{"class":316},"  // For example we just create url on client-side\n",[99,325,327,330,333,335,338,341,344],{"class":101,"line":326},18,[99,328,329],{"class":105},"  const",[99,331,332],{"class":153}," url",[99,334,140],{"class":105},[99,336,337],{"class":153}," URL",[99,339,340],{"class":109},".",[99,342,343],{"class":136},"createObjectURL",[99,345,346],{"class":109},"(file); \n",[99,348,350,352],{"class":101,"line":349},19,[99,351,169],{"class":105},[99,353,354],{"class":109}," url;\n",[99,356,358],{"class":101,"line":357},20,[99,359,279],{"class":109},[99,361,363],{"class":101,"line":362},21,[99,364,127],{"emptyLinePlaceholder":126},[99,366,368,371,374,377,380],{"class":101,"line":367},22,[99,369,370],{"class":105},"export",[99,372,373],{"class":105}," default",[99,375,376],{"class":105}," function",[99,378,379],{"class":136}," App",[99,381,382],{"class":109},"() {\n",[99,384,386,388,391,394,397,400,403,405,408,411,414],{"class":101,"line":385},23,[99,387,329],{"class":105},[99,389,390],{"class":109}," [",[99,392,393],{"class":153},"originalImageSrc",[99,395,396],{"class":109},", ",[99,398,399],{"class":153},"setOriginalImageSrc",[99,401,402],{"class":109},"] ",[99,404,226],{"class":105},[99,406,407],{"class":136}," useState",[99,409,410],{"class":109},"(",[99,412,413],{"class":116},"\"\"",[99,415,416],{"class":109},");\n",[99,418,420],{"class":101,"line":419},24,[99,421,127],{"emptyLinePlaceholder":126},[99,423,425,427,430,432,435],{"class":101,"line":424},25,[99,426,329],{"class":105},[99,428,429],{"class":153}," handleFileUpload",[99,431,140],{"class":105},[99,433,434],{"class":136}," useCallback",[99,436,437],{"class":109},"(\n",[99,439,441,444,446,449,451,454,456,459,461,464,467,469],{"class":101,"line":440},26,[99,442,443],{"class":105},"    async",[99,445,143],{"class":109},[99,447,448],{"class":146},"event",[99,450,150],{"class":105},[99,452,453],{"class":136}," React",[99,455,340],{"class":109},[99,457,458],{"class":136},"ChangeEvent",[99,460,178],{"class":109},[99,462,463],{"class":136},"HTMLInputElement",[99,465,466],{"class":109},">) ",[99,468,160],{"class":105},[99,470,163],{"class":109},[99,472,474,477,479,482,485,488],{"class":101,"line":473},27,[99,475,476],{"class":105},"      if",[99,478,143],{"class":109},[99,480,481],{"class":105},"!",[99,483,484],{"class":109},"event.target.files?.",[99,486,487],{"class":153},"length",[99,489,490],{"class":109},") {\n",[99,492,494,497],{"class":101,"line":493},28,[99,495,496],{"class":105},"        return",[99,498,120],{"class":109},[99,500,502],{"class":101,"line":501},29,[99,503,504],{"class":109},"      }\n",[99,506,508,511,514,516,519,522],{"class":101,"line":507},30,[99,509,510],{"class":105},"      const",[99,512,513],{"class":153}," file",[99,515,140],{"class":105},[99,517,518],{"class":109}," event.target.files[",[99,520,521],{"class":153},"0",[99,523,524],{"class":109},"];\n",[99,526,528,530,532,534,537,539],{"class":101,"line":527},31,[99,529,510],{"class":105},[99,531,332],{"class":153},[99,533,140],{"class":105},[99,535,536],{"class":105}," await",[99,538,292],{"class":136},[99,540,541],{"class":109},"(file);\n",[99,543,545,548],{"class":101,"line":544},32,[99,546,547],{"class":136},"      setOriginalImageSrc",[99,549,550],{"class":109},"(url);\n",[99,552,554],{"class":101,"line":553},33,[99,555,556],{"class":109},"    },\n",[99,558,560],{"class":101,"line":559},34,[99,561,562],{"class":109},"    []\n",[99,564,566],{"class":101,"line":565},35,[99,567,568],{"class":109},"  );\n",[99,570,572],{"class":101,"line":571},36,[99,573,127],{"emptyLinePlaceholder":126},[99,575,577,579],{"class":101,"line":576},37,[99,578,169],{"class":105},[99,580,581],{"class":109}," (\n",[99,583,585,588,592,595,597,600],{"class":101,"line":584},38,[99,586,587],{"class":109},"    \u003C",[99,589,591],{"class":590},"s9eBZ","div",[99,593,594],{"class":136}," className",[99,596,226],{"class":105},[99,598,599],{"class":116},"\"App\"",[99,601,602],{"class":109},">\n",[99,604,606,609,612,615,617,620,623,625],{"class":101,"line":605},39,[99,607,608],{"class":109},"      \u003C",[99,610,611],{"class":590},"input",[99,613,614],{"class":136}," type",[99,616,226],{"class":105},[99,618,619],{"class":116},"\"file\"",[99,621,622],{"class":136}," onChange",[99,624,226],{"class":105},[99,626,627],{"class":109},"{handleFileUpload} />\n",[99,629,631,633,635,638,640],{"class":101,"line":630},40,[99,632,608],{"class":109},[99,634,36],{"class":590},[99,636,637],{"class":136}," src",[99,639,226],{"class":105},[99,641,642],{"class":109},"{originalImageSrc} />\n",[99,644,646,649,651],{"class":101,"line":645},41,[99,647,648],{"class":109},"    \u003C/",[99,650,591],{"class":590},[99,652,602],{"class":109},[99,654,656],{"class":101,"line":655},42,[99,657,568],{"class":109},[99,659,661],{"class":101,"line":660},43,[99,662,663],{"class":109},"}\n",[15,665,666],{},"Теперь нам необходимо считать файл как картинку, чтобы создать миниатюру.",[15,668,669,670],{},"Для этого напишем небольшой хелпер, который загружает картинку по переданному url и возвращает ",[22,671,181],{},[90,673,677],{"className":674,"code":675,"language":676,"meta":95,"style":95},"language-ts shiki shiki-themes github-light github-dark","const loadImage = (imageUrl: string) => {\n  return new Promise\u003CHTMLImageElement>((resolve) => {\n    const img = new Image();\n    img.src = imageUrl;\n\n    img.onload = () => {\n      resolve(img);\n    };\n  });\n};\n","ts",[22,678,679,701,723,737,745,749,763,769,773,777],{"__ignoreMap":95},[99,680,681,683,685,687,689,691,693,695,697,699],{"class":101,"line":102},[99,682,133],{"class":105},[99,684,137],{"class":136},[99,686,140],{"class":105},[99,688,143],{"class":109},[99,690,147],{"class":146},[99,692,150],{"class":105},[99,694,154],{"class":153},[99,696,157],{"class":109},[99,698,160],{"class":105},[99,700,163],{"class":109},[99,702,703,705,707,709,711,713,715,717,719,721],{"class":101,"line":123},[99,704,169],{"class":105},[99,706,172],{"class":105},[99,708,175],{"class":153},[99,710,178],{"class":109},[99,712,181],{"class":136},[99,714,184],{"class":109},[99,716,187],{"class":146},[99,718,157],{"class":109},[99,720,160],{"class":105},[99,722,163],{"class":109},[99,724,725,727,729,731,733,735],{"class":101,"line":130},[99,726,199],{"class":105},[99,728,202],{"class":153},[99,730,140],{"class":105},[99,732,172],{"class":105},[99,734,209],{"class":136},[99,736,212],{"class":109},[99,738,739,741,743],{"class":101,"line":166},[99,740,223],{"class":109},[99,742,226],{"class":105},[99,744,229],{"class":109},[99,746,747],{"class":101,"line":196},[99,748,127],{"emptyLinePlaceholder":126},[99,750,751,753,755,757,759,761],{"class":101,"line":215},[99,752,240],{"class":109},[99,754,243],{"class":136},[99,756,140],{"class":105},[99,758,248],{"class":109},[99,760,160],{"class":105},[99,762,163],{"class":109},[99,764,765,767],{"class":101,"line":220},[99,766,258],{"class":136},[99,768,261],{"class":109},[99,770,771],{"class":101,"line":232},[99,772,267],{"class":109},[99,774,775],{"class":101,"line":237},[99,776,273],{"class":109},[99,778,779],{"class":101,"line":255},[99,780,279],{"class":109},[15,782,783,784,150],{},"Теперь необходимо создать миниатюру изображения, для этого воспользуемся ",[22,785,786],{},"canvas",[90,788,790],{"className":674,"code":789,"language":676,"meta":95,"style":95},"const size = Math.max(img.width, img.height);\nconst w = img.width = Math.round(100 * img.width / size);\nconst h = img.height = Math.round(100 * img.height / size);\n\n// Create image thumb (100x100 maximum size)\nconst canvas = document.createElement('canvas');\nconst c = canvas.getContext('2d');\ncanvas.width = w;\ncanvas.height = h;\nc.drawImage(img, 0, 0, w, h);\n",[22,791,792,810,845,875,879,884,906,928,938,948],{"__ignoreMap":95},[99,793,794,796,799,801,804,807],{"class":101,"line":102},[99,795,133],{"class":105},[99,797,798],{"class":153}," size",[99,800,140],{"class":105},[99,802,803],{"class":109}," Math.",[99,805,806],{"class":136},"max",[99,808,809],{"class":109},"(img.width, img.height);\n",[99,811,812,814,817,819,822,824,826,829,831,834,837,839,842],{"class":101,"line":123},[99,813,133],{"class":105},[99,815,816],{"class":153}," w",[99,818,140],{"class":105},[99,820,821],{"class":109}," img.width ",[99,823,226],{"class":105},[99,825,803],{"class":109},[99,827,828],{"class":136},"round",[99,830,410],{"class":109},[99,832,833],{"class":153},"100",[99,835,836],{"class":105}," *",[99,838,821],{"class":109},[99,840,841],{"class":105},"/",[99,843,844],{"class":109}," size);\n",[99,846,847,849,852,854,857,859,861,863,865,867,869,871,873],{"class":101,"line":130},[99,848,133],{"class":105},[99,850,851],{"class":153}," h",[99,853,140],{"class":105},[99,855,856],{"class":109}," img.height ",[99,858,226],{"class":105},[99,860,803],{"class":109},[99,862,828],{"class":136},[99,864,410],{"class":109},[99,866,833],{"class":153},[99,868,836],{"class":105},[99,870,856],{"class":109},[99,872,841],{"class":105},[99,874,844],{"class":109},[99,876,877],{"class":101,"line":166},[99,878,127],{"emptyLinePlaceholder":126},[99,880,881],{"class":101,"line":196},[99,882,883],{"class":316},"// Create image thumb (100x100 maximum size)\n",[99,885,886,888,891,893,896,899,901,904],{"class":101,"line":215},[99,887,133],{"class":105},[99,889,890],{"class":153}," canvas",[99,892,140],{"class":105},[99,894,895],{"class":109}," document.",[99,897,898],{"class":136},"createElement",[99,900,410],{"class":109},[99,902,903],{"class":116},"'canvas'",[99,905,416],{"class":109},[99,907,908,910,913,915,918,921,923,926],{"class":101,"line":220},[99,909,133],{"class":105},[99,911,912],{"class":153}," c",[99,914,140],{"class":105},[99,916,917],{"class":109}," canvas.",[99,919,920],{"class":136},"getContext",[99,922,410],{"class":109},[99,924,925],{"class":116},"'2d'",[99,927,416],{"class":109},[99,929,930,933,935],{"class":101,"line":232},[99,931,932],{"class":109},"canvas.width ",[99,934,226],{"class":105},[99,936,937],{"class":109}," w;\n",[99,939,940,943,945],{"class":101,"line":237},[99,941,942],{"class":109},"canvas.height ",[99,944,226],{"class":105},[99,946,947],{"class":109}," h;\n",[99,949,950,953,956,959,961,963,965],{"class":101,"line":255},[99,951,952],{"class":109},"c.",[99,954,955],{"class":136},"drawImage",[99,957,958],{"class":109},"(img, ",[99,960,521],{"class":153},[99,962,396],{"class":109},[99,964,521],{"class":153},[99,966,967],{"class":109},", w, h);\n",[15,969,970,971,978,979,340],{},"После чего достаем из полученной миниатюры ",[70,972,975],{"href":973,"rel":974},"https://developer.mozilla.org/en-US/docs/Web/API/ImageData",[74],[22,976,977],{},"ImageData"," и скармливаем полученный массив пикселей методу ",[22,980,981],{},"rgbaToThumbHash",[15,983,984,985,988,989,992],{},"Полученный ",[44,986,987],{},"Uint8Array"," я конвертирую в ",[44,990,991],{},"base64"," строку, которую мы затем можем сохранить на сервере.",[90,994,997],{"className":674,"code":995,"highlights":996,"language":676,"meta":95,"style":95},"import { rgbaToThumbHash } from 'thumbhash';\n\nasync function generateImageThumb(img: HTMLImageElement) {\n  const size = Math.max(img.width, img.height);\n  const w = img.width = Math.round(100 * img.width / size);\n  const h = img.height = Math.round(100 * img.height / size);\n\n  // // Create image thumb (100x100 maximum size)\n  const canvas = document.createElement('canvas');\n  const c = canvas.getContext('2d');\n  canvas.width = w;\n  canvas.height = h;\n  c.drawImage(img, 0, 0, w, h);\n  // Get pixels array\n  const pixels = c.getImageData(0, 0, w, h);\n  // Get thumbhash (Uint8Array)\n  const hash = rgbaToThumbHash(w, h, pixels.data);\n  // convert Uint8Array to base64 string\n  const binString = String.fromCodePoint(...hash);\n  return btoa(binString);\n}\n",[287,320,349],[22,998,999,1013,1017,1038,1052,1080,1108,1112,1120,1138,1156,1165,1174,1191,1196,1223,1228,1244,1249,1273,1283],{"__ignoreMap":95},[99,1000,1001,1003,1006,1008,1011],{"class":101,"line":102},[99,1002,106],{"class":105},[99,1004,1005],{"class":109}," { rgbaToThumbHash } ",[99,1007,113],{"class":105},[99,1009,1010],{"class":116}," 'thumbhash'",[99,1012,120],{"class":109},[99,1014,1015],{"class":101,"line":123},[99,1016,127],{"emptyLinePlaceholder":126},[99,1018,1019,1022,1024,1027,1029,1031,1033,1036],{"class":101,"line":130},[99,1020,1021],{"class":105},"async",[99,1023,376],{"class":105},[99,1025,1026],{"class":136}," generateImageThumb",[99,1028,410],{"class":109},[99,1030,36],{"class":146},[99,1032,150],{"class":105},[99,1034,1035],{"class":136}," HTMLImageElement",[99,1037,490],{"class":109},[99,1039,1040,1042,1044,1046,1048,1050],{"class":101,"line":166},[99,1041,329],{"class":105},[99,1043,798],{"class":153},[99,1045,140],{"class":105},[99,1047,803],{"class":109},[99,1049,806],{"class":136},[99,1051,809],{"class":109},[99,1053,1054,1056,1058,1060,1062,1064,1066,1068,1070,1072,1074,1076,1078],{"class":101,"line":196},[99,1055,329],{"class":105},[99,1057,816],{"class":153},[99,1059,140],{"class":105},[99,1061,821],{"class":109},[99,1063,226],{"class":105},[99,1065,803],{"class":109},[99,1067,828],{"class":136},[99,1069,410],{"class":109},[99,1071,833],{"class":153},[99,1073,836],{"class":105},[99,1075,821],{"class":109},[99,1077,841],{"class":105},[99,1079,844],{"class":109},[99,1081,1082,1084,1086,1088,1090,1092,1094,1096,1098,1100,1102,1104,1106],{"class":101,"line":215},[99,1083,329],{"class":105},[99,1085,851],{"class":153},[99,1087,140],{"class":105},[99,1089,856],{"class":109},[99,1091,226],{"class":105},[99,1093,803],{"class":109},[99,1095,828],{"class":136},[99,1097,410],{"class":109},[99,1099,833],{"class":153},[99,1101,836],{"class":105},[99,1103,856],{"class":109},[99,1105,841],{"class":105},[99,1107,844],{"class":109},[99,1109,1110],{"class":101,"line":220},[99,1111,127],{"emptyLinePlaceholder":126},[99,1113,1114,1117],{"class":101,"line":232},[99,1115,1116],{"class":316},"  //",[99,1118,1119],{"class":316}," // Create image thumb (100x100 maximum size)\n",[99,1121,1122,1124,1126,1128,1130,1132,1134,1136],{"class":101,"line":237},[99,1123,329],{"class":105},[99,1125,890],{"class":153},[99,1127,140],{"class":105},[99,1129,895],{"class":109},[99,1131,898],{"class":136},[99,1133,410],{"class":109},[99,1135,903],{"class":116},[99,1137,416],{"class":109},[99,1139,1140,1142,1144,1146,1148,1150,1152,1154],{"class":101,"line":255},[99,1141,329],{"class":105},[99,1143,912],{"class":153},[99,1145,140],{"class":105},[99,1147,917],{"class":109},[99,1149,920],{"class":136},[99,1151,410],{"class":109},[99,1153,925],{"class":116},[99,1155,416],{"class":109},[99,1157,1158,1161,1163],{"class":101,"line":264},[99,1159,1160],{"class":109},"  canvas.width ",[99,1162,226],{"class":105},[99,1164,937],{"class":109},[99,1166,1167,1170,1172],{"class":101,"line":270},[99,1168,1169],{"class":109},"  canvas.height ",[99,1171,226],{"class":105},[99,1173,947],{"class":109},[99,1175,1176,1179,1181,1183,1185,1187,1189],{"class":101,"line":276},[99,1177,1178],{"class":109},"  c.",[99,1180,955],{"class":136},[99,1182,958],{"class":109},[99,1184,521],{"class":153},[99,1186,396],{"class":109},[99,1188,521],{"class":153},[99,1190,967],{"class":109},[99,1192,1193],{"class":101,"line":282},[99,1194,1195],{"class":316},"  // Get pixels array\n",[99,1197,1200,1202,1205,1207,1210,1213,1215,1217,1219,1221],{"class":1198,"line":287},[101,1199],"highlight",[99,1201,329],{"class":105},[99,1203,1204],{"class":153}," pixels",[99,1206,140],{"class":105},[99,1208,1209],{"class":109}," c.",[99,1211,1212],{"class":136},"getImageData",[99,1214,410],{"class":109},[99,1216,521],{"class":153},[99,1218,396],{"class":109},[99,1220,521],{"class":153},[99,1222,967],{"class":109},[99,1224,1225],{"class":101,"line":313},[99,1226,1227],{"class":316},"  // Get thumbhash (Uint8Array)\n",[99,1229,1231,1233,1236,1238,1241],{"class":1230,"line":320},[101,1199],[99,1232,329],{"class":105},[99,1234,1235],{"class":153}," hash",[99,1237,140],{"class":105},[99,1239,1240],{"class":136}," rgbaToThumbHash",[99,1242,1243],{"class":109},"(w, h, pixels.data);\n",[99,1245,1246],{"class":101,"line":326},[99,1247,1248],{"class":316},"  // convert Uint8Array to base64 string\n",[99,1250,1252,1254,1257,1259,1262,1265,1267,1270],{"class":1251,"line":349},[101,1199],[99,1253,329],{"class":105},[99,1255,1256],{"class":153}," binString",[99,1258,140],{"class":105},[99,1260,1261],{"class":109}," String.",[99,1263,1264],{"class":136},"fromCodePoint",[99,1266,410],{"class":109},[99,1268,1269],{"class":105},"...",[99,1271,1272],{"class":109},"hash);\n",[99,1274,1275,1277,1280],{"class":101,"line":357},[99,1276,169],{"class":105},[99,1278,1279],{"class":136}," btoa",[99,1281,1282],{"class":109},"(binString);\n",[99,1284,1285],{"class":101,"line":362},[99,1286,663],{"class":109},[15,1288,1289],{},"В результате этих махинаций мы получаем такую строку",[90,1291,1295],{"className":1292,"code":1293,"language":1294,"meta":95,"style":95},"language-txt shiki shiki-themes github-light github-dark","0ucJJgoHiHeId5eYV4d3hneYiHiPiPc=\n","txt",[22,1296,1297],{"__ignoreMap":95},[99,1298,1299],{"class":101,"line":102},[99,1300,1293],{},[15,1302,1303],{},"Весит она всего 32 байта",[90,1305,1307],{"className":674,"code":1306,"language":676,"meta":95,"style":95},"new Blob([\"0ucJJgoHiHeId5eYV4d3hneYiHiPiPc=\"]).size; // 32\n",[22,1308,1309],{"__ignoreMap":95},[99,1310,1311,1314,1317,1320,1323,1326],{"class":101,"line":102},[99,1312,1313],{"class":105},"new",[99,1315,1316],{"class":136}," Blob",[99,1318,1319],{"class":109},"([",[99,1321,1322],{"class":116},"\"0ucJJgoHiHeId5eYV4d3hneYiHiPiPc=\"",[99,1324,1325],{"class":109},"]).size; ",[99,1327,1328],{"class":316},"// 32\n",[15,1330,1331],{},"Ее можно сохранить на сервере и присылать вместе с объектом поста",[90,1333,1335],{"className":674,"code":1334,"language":676,"meta":95,"style":95},"[\n  {\n    id: '1',\n    title: 'Post title',\n    image: '/path/to/image1.png',\n    thumbhash: '0ucJJgoHiHeId5eYV4d3hneYiHiPiPc=',\n  },\n  // ...\n];\n",[22,1336,1337,1342,1347,1358,1368,1378,1388,1393,1398],{"__ignoreMap":95},[99,1338,1339],{"class":101,"line":102},[99,1340,1341],{"class":109},"[\n",[99,1343,1344],{"class":101,"line":123},[99,1345,1346],{"class":109},"  {\n",[99,1348,1349,1352,1355],{"class":101,"line":130},[99,1350,1351],{"class":109},"    id: ",[99,1353,1354],{"class":116},"'1'",[99,1356,1357],{"class":109},",\n",[99,1359,1360,1363,1366],{"class":101,"line":166},[99,1361,1362],{"class":109},"    title: ",[99,1364,1365],{"class":116},"'Post title'",[99,1367,1357],{"class":109},[99,1369,1370,1373,1376],{"class":101,"line":196},[99,1371,1372],{"class":109},"    image: ",[99,1374,1375],{"class":116},"'/path/to/image1.png'",[99,1377,1357],{"class":109},[99,1379,1380,1383,1386],{"class":101,"line":215},[99,1381,1382],{"class":109},"    thumbhash: ",[99,1384,1385],{"class":116},"'0ucJJgoHiHeId5eYV4d3hneYiHiPiPc='",[99,1387,1357],{"class":109},[99,1389,1390],{"class":101,"line":220},[99,1391,1392],{"class":109},"  },\n",[99,1394,1395],{"class":101,"line":232},[99,1396,1397],{"class":316},"  // ...\n",[99,1399,1400],{"class":101,"line":237},[99,1401,524],{"class":109},[15,1403,1404],{},"Далее на клиенте нужно преобразовать ее сначала в Uint8Array, а затем в base64 картинку",[90,1406,1408],{"className":674,"code":1407,"language":676,"meta":95,"style":95},"const thumbToImageSrc = (thumb: string) => {\n  const binString = atob(thumb);\n  const data = Uint8Array.from(binString, (m) => m.codePointAt(0));\n  const src = thumbHashToDataURL(data);\n  return src;\n};\n",[22,1409,1410,1434,1448,1485,1499,1506],{"__ignoreMap":95},[99,1411,1412,1414,1417,1419,1421,1424,1426,1428,1430,1432],{"class":101,"line":102},[99,1413,133],{"class":105},[99,1415,1416],{"class":136}," thumbToImageSrc",[99,1418,140],{"class":105},[99,1420,143],{"class":109},[99,1422,1423],{"class":146},"thumb",[99,1425,150],{"class":105},[99,1427,154],{"class":153},[99,1429,157],{"class":109},[99,1431,160],{"class":105},[99,1433,163],{"class":109},[99,1435,1436,1438,1440,1442,1445],{"class":101,"line":123},[99,1437,329],{"class":105},[99,1439,1256],{"class":153},[99,1441,140],{"class":105},[99,1443,1444],{"class":136}," atob",[99,1446,1447],{"class":109},"(thumb);\n",[99,1449,1450,1452,1455,1457,1460,1462,1465,1468,1470,1472,1475,1478,1480,1482],{"class":101,"line":130},[99,1451,329],{"class":105},[99,1453,1454],{"class":153}," data",[99,1456,140],{"class":105},[99,1458,1459],{"class":109}," Uint8Array.",[99,1461,113],{"class":136},[99,1463,1464],{"class":109},"(binString, (",[99,1466,1467],{"class":146},"m",[99,1469,157],{"class":109},[99,1471,160],{"class":105},[99,1473,1474],{"class":109}," m.",[99,1476,1477],{"class":136},"codePointAt",[99,1479,410],{"class":109},[99,1481,521],{"class":153},[99,1483,1484],{"class":109},"));\n",[99,1486,1487,1489,1491,1493,1496],{"class":101,"line":166},[99,1488,329],{"class":105},[99,1490,637],{"class":153},[99,1492,140],{"class":105},[99,1494,1495],{"class":136}," thumbHashToDataURL",[99,1497,1498],{"class":109},"(data);\n",[99,1500,1501,1503],{"class":101,"line":196},[99,1502,169],{"class":105},[99,1504,1505],{"class":109}," src;\n",[99,1507,1508],{"class":101,"line":215},[99,1509,279],{"class":109},[15,1511,1512],{},"Наконец нам нужен компонент, который будет запускать загрузку оригинальной картинки и отображать thumbhash миниатюру на время загрузки",[90,1514,1516],{"className":92,"code":1515,"language":94,"meta":95,"style":95},"type ProgressiveImageProps = {\n    src: string;\n    thumbHash: string;\n}\n\nconst ProgressiveImage: React.FC\u003CProgressiveImageProps> = ({ src: originalImageSrc, thumbHash }) => {\n  const thumb = useMemo(() => thumbHash ? thumbToImageSrc(thumbHash) : null, [thumbHash]);\n  const [imgSrc, setImgSrc] = useState(thumb ? thumb : originalImageSrc);\n\n  const loadOriginalImage = useCallback(async () => {\n    await loadImage(originalImageSrc);\n    setImgSrc(originalImageSrc);\n  }, [originalImageSrc]);\n\n  useEffect(() => {\n    if (thumbHash ) {\n      loadOriginalImage();\n    };\n  }, [loadOriginalImage, thumbHash]);\n\n  return (\n    \u003Cimg src={imgSrc} />\n  );\n};\n",[22,1517,1518,1530,1541,1552,1556,1560,1609,1645,1678,1682,1703,1713,1720,1725,1729,1740,1748,1755,1759,1764,1768,1774,1787,1791],{"__ignoreMap":95},[99,1519,1520,1523,1526,1528],{"class":101,"line":102},[99,1521,1522],{"class":105},"type",[99,1524,1525],{"class":136}," ProgressiveImageProps",[99,1527,140],{"class":105},[99,1529,163],{"class":109},[99,1531,1532,1535,1537,1539],{"class":101,"line":123},[99,1533,1534],{"class":146},"    src",[99,1536,150],{"class":105},[99,1538,154],{"class":153},[99,1540,120],{"class":109},[99,1542,1543,1546,1548,1550],{"class":101,"line":130},[99,1544,1545],{"class":146},"    thumbHash",[99,1547,150],{"class":105},[99,1549,154],{"class":153},[99,1551,120],{"class":109},[99,1553,1554],{"class":101,"line":166},[99,1555,663],{"class":109},[99,1557,1558],{"class":101,"line":196},[99,1559,127],{"emptyLinePlaceholder":126},[99,1561,1562,1564,1567,1569,1571,1573,1576,1578,1581,1584,1586,1589,1592,1595,1597,1599,1602,1605,1607],{"class":101,"line":215},[99,1563,133],{"class":105},[99,1565,1566],{"class":136}," ProgressiveImage",[99,1568,150],{"class":105},[99,1570,453],{"class":136},[99,1572,340],{"class":109},[99,1574,1575],{"class":136},"FC",[99,1577,178],{"class":109},[99,1579,1580],{"class":136},"ProgressiveImageProps",[99,1582,1583],{"class":109},"> ",[99,1585,226],{"class":105},[99,1587,1588],{"class":109}," ({ ",[99,1590,1591],{"class":146},"src",[99,1593,1594],{"class":109},": ",[99,1596,393],{"class":146},[99,1598,396],{"class":109},[99,1600,1601],{"class":146},"thumbHash",[99,1603,1604],{"class":109}," }) ",[99,1606,160],{"class":105},[99,1608,163],{"class":109},[99,1610,1611,1613,1616,1618,1621,1624,1626,1629,1632,1634,1637,1639,1642],{"class":101,"line":220},[99,1612,329],{"class":105},[99,1614,1615],{"class":153}," thumb",[99,1617,140],{"class":105},[99,1619,1620],{"class":136}," useMemo",[99,1622,1623],{"class":109},"(() ",[99,1625,160],{"class":105},[99,1627,1628],{"class":109}," thumbHash ",[99,1630,1631],{"class":105},"?",[99,1633,1416],{"class":136},[99,1635,1636],{"class":109},"(thumbHash) ",[99,1638,150],{"class":105},[99,1640,1641],{"class":153}," null",[99,1643,1644],{"class":109},", [thumbHash]);\n",[99,1646,1647,1649,1651,1654,1656,1659,1661,1663,1665,1668,1670,1673,1675],{"class":101,"line":232},[99,1648,329],{"class":105},[99,1650,390],{"class":109},[99,1652,1653],{"class":153},"imgSrc",[99,1655,396],{"class":109},[99,1657,1658],{"class":153},"setImgSrc",[99,1660,402],{"class":109},[99,1662,226],{"class":105},[99,1664,407],{"class":136},[99,1666,1667],{"class":109},"(thumb ",[99,1669,1631],{"class":105},[99,1671,1672],{"class":109}," thumb ",[99,1674,150],{"class":105},[99,1676,1677],{"class":109}," originalImageSrc);\n",[99,1679,1680],{"class":101,"line":237},[99,1681,127],{"emptyLinePlaceholder":126},[99,1683,1684,1686,1689,1691,1693,1695,1697,1699,1701],{"class":101,"line":255},[99,1685,329],{"class":105},[99,1687,1688],{"class":153}," loadOriginalImage",[99,1690,140],{"class":105},[99,1692,434],{"class":136},[99,1694,410],{"class":109},[99,1696,1021],{"class":105},[99,1698,248],{"class":109},[99,1700,160],{"class":105},[99,1702,163],{"class":109},[99,1704,1705,1708,1710],{"class":101,"line":264},[99,1706,1707],{"class":105},"    await",[99,1709,137],{"class":136},[99,1711,1712],{"class":109},"(originalImageSrc);\n",[99,1714,1715,1718],{"class":101,"line":270},[99,1716,1717],{"class":136},"    setImgSrc",[99,1719,1712],{"class":109},[99,1721,1722],{"class":101,"line":276},[99,1723,1724],{"class":109},"  }, [originalImageSrc]);\n",[99,1726,1727],{"class":101,"line":282},[99,1728,127],{"emptyLinePlaceholder":126},[99,1730,1731,1734,1736,1738],{"class":101,"line":287},[99,1732,1733],{"class":136},"  useEffect",[99,1735,1623],{"class":109},[99,1737,160],{"class":105},[99,1739,163],{"class":109},[99,1741,1742,1745],{"class":101,"line":313},[99,1743,1744],{"class":105},"    if",[99,1746,1747],{"class":109}," (thumbHash ) {\n",[99,1749,1750,1753],{"class":101,"line":320},[99,1751,1752],{"class":136},"      loadOriginalImage",[99,1754,212],{"class":109},[99,1756,1757],{"class":101,"line":326},[99,1758,267],{"class":109},[99,1760,1761],{"class":101,"line":349},[99,1762,1763],{"class":109},"  }, [loadOriginalImage, thumbHash]);\n",[99,1765,1766],{"class":101,"line":357},[99,1767,127],{"emptyLinePlaceholder":126},[99,1769,1770,1772],{"class":101,"line":362},[99,1771,169],{"class":105},[99,1773,581],{"class":109},[99,1775,1776,1778,1780,1782,1784],{"class":101,"line":367},[99,1777,587],{"class":109},[99,1779,36],{"class":590},[99,1781,637],{"class":136},[99,1783,226],{"class":105},[99,1785,1786],{"class":109},"{imgSrc} />\n",[99,1788,1789],{"class":101,"line":385},[99,1790,568],{"class":109},[99,1792,1793],{"class":101,"line":419},[99,1794,279],{"class":109},[10,1796,1798],{"id":1797},"generate-thumbhash-on-server-side","Генерация thumbhash на сервере",[15,1800,1801,1802,1809],{},"Скорее всего будет использоваться ",[70,1803,1806],{"href":1804,"rel":1805},"https://developer.mozilla.org/ru/docs/Web/API/FormData",[74],[22,1807,1808],{},"FormData",", чтобы загрузить файл на сервер.",[90,1811,1813],{"className":674,"code":1812,"language":676,"meta":95,"style":95},"export async function POST(request: NextRequest) {\n  const formData = await request.formData();\n  const file = formData.get('file') as File;\n\n  if (!file) {\n    return NextResponse.json({\n      code: 'FILE_NOT_FOUND'\n    }, {\n      status: 404\n    });\n  }\n\n  const arrayBuffer = await file.arrayBuffer();\n  const buffer = Buffer.from(arrayBuffer);\n\n  const url = await uploadFile(buffer); // save file on your server somehow\n  const thumbhash = await generateThumbhash(buffer); // We need to implement this\n\n  return NextResponse.json({\n    url,\n    thumbhash\n  });\n}\n",[22,1814,1815,1839,1858,1886,1890,1902,1916,1924,1929,1937,1942,1947,1951,1970,1987,1991,2010,2029,2033,2043,2048,2053,2057],{"__ignoreMap":95},[99,1816,1817,1819,1822,1824,1827,1829,1832,1834,1837],{"class":101,"line":102},[99,1818,370],{"class":105},[99,1820,1821],{"class":105}," async",[99,1823,376],{"class":105},[99,1825,1826],{"class":136}," POST",[99,1828,410],{"class":109},[99,1830,1831],{"class":146},"request",[99,1833,150],{"class":105},[99,1835,1836],{"class":136}," NextRequest",[99,1838,490],{"class":109},[99,1840,1841,1843,1846,1848,1850,1853,1856],{"class":101,"line":123},[99,1842,329],{"class":105},[99,1844,1845],{"class":153}," formData",[99,1847,140],{"class":105},[99,1849,536],{"class":105},[99,1851,1852],{"class":109}," request.",[99,1854,1855],{"class":136},"formData",[99,1857,212],{"class":109},[99,1859,1860,1862,1864,1866,1869,1872,1874,1877,1879,1882,1884],{"class":101,"line":130},[99,1861,329],{"class":105},[99,1863,513],{"class":153},[99,1865,140],{"class":105},[99,1867,1868],{"class":109}," formData.",[99,1870,1871],{"class":136},"get",[99,1873,410],{"class":109},[99,1875,1876],{"class":116},"'file'",[99,1878,157],{"class":109},[99,1880,1881],{"class":105},"as",[99,1883,304],{"class":136},[99,1885,120],{"class":109},[99,1887,1888],{"class":101,"line":166},[99,1889,127],{"emptyLinePlaceholder":126},[99,1891,1892,1895,1897,1899],{"class":101,"line":196},[99,1893,1894],{"class":105},"  if",[99,1896,143],{"class":109},[99,1898,481],{"class":105},[99,1900,1901],{"class":109},"file) {\n",[99,1903,1904,1907,1910,1913],{"class":101,"line":215},[99,1905,1906],{"class":105},"    return",[99,1908,1909],{"class":109}," NextResponse.",[99,1911,1912],{"class":136},"json",[99,1914,1915],{"class":109},"({\n",[99,1917,1918,1921],{"class":101,"line":220},[99,1919,1920],{"class":109},"      code: ",[99,1922,1923],{"class":116},"'FILE_NOT_FOUND'\n",[99,1925,1926],{"class":101,"line":232},[99,1927,1928],{"class":109},"    }, {\n",[99,1930,1931,1934],{"class":101,"line":237},[99,1932,1933],{"class":109},"      status: ",[99,1935,1936],{"class":153},"404\n",[99,1938,1939],{"class":101,"line":255},[99,1940,1941],{"class":109},"    });\n",[99,1943,1944],{"class":101,"line":264},[99,1945,1946],{"class":109},"  }\n",[99,1948,1949],{"class":101,"line":270},[99,1950,127],{"emptyLinePlaceholder":126},[99,1952,1953,1955,1958,1960,1962,1965,1968],{"class":101,"line":276},[99,1954,329],{"class":105},[99,1956,1957],{"class":153}," arrayBuffer",[99,1959,140],{"class":105},[99,1961,536],{"class":105},[99,1963,1964],{"class":109}," file.",[99,1966,1967],{"class":136},"arrayBuffer",[99,1969,212],{"class":109},[99,1971,1972,1974,1977,1979,1982,1984],{"class":101,"line":282},[99,1973,329],{"class":105},[99,1975,1976],{"class":153}," buffer",[99,1978,140],{"class":105},[99,1980,1981],{"class":109}," Buffer.",[99,1983,113],{"class":136},[99,1985,1986],{"class":109},"(arrayBuffer);\n",[99,1988,1989],{"class":101,"line":287},[99,1990,127],{"emptyLinePlaceholder":126},[99,1992,1993,1995,1997,1999,2001,2004,2007],{"class":101,"line":313},[99,1994,329],{"class":105},[99,1996,332],{"class":153},[99,1998,140],{"class":105},[99,2000,536],{"class":105},[99,2002,2003],{"class":136}," uploadFile",[99,2005,2006],{"class":109},"(buffer); ",[99,2008,2009],{"class":316},"// save file on your server somehow\n",[99,2011,2012,2014,2017,2019,2021,2024,2026],{"class":101,"line":320},[99,2013,329],{"class":105},[99,2015,2016],{"class":153}," thumbhash",[99,2018,140],{"class":105},[99,2020,536],{"class":105},[99,2022,2023],{"class":136}," generateThumbhash",[99,2025,2006],{"class":109},[99,2027,2028],{"class":316},"// We need to implement this\n",[99,2030,2031],{"class":101,"line":326},[99,2032,127],{"emptyLinePlaceholder":126},[99,2034,2035,2037,2039,2041],{"class":101,"line":349},[99,2036,169],{"class":105},[99,2038,1909],{"class":109},[99,2040,1912],{"class":136},[99,2042,1915],{"class":109},[99,2044,2045],{"class":101,"line":357},[99,2046,2047],{"class":109},"    url,\n",[99,2049,2050],{"class":101,"line":362},[99,2051,2052],{"class":109},"    thumbhash\n",[99,2054,2055],{"class":101,"line":367},[99,2056,273],{"class":109},[99,2058,2059],{"class":101,"line":385},[99,2060,663],{"class":109},[2062,2063,2065],"h3",{"id":2064},"generate-thumbhash-on-server-side-using-canvas","При помощи canvas",[15,2067,2068,2069],{},"Чтобы сгенерировать thumbhash, нужно считать данные изображения, только вот сервере у нас нет нативной поддержки canvas и нужно будет воспользоваться сторонней библиотекой, например ",[70,2070,2071],{"href":2071,"rel":2072},"https://www.npmjs.com/package/canvas",[74],[90,2074,2076],{"className":674,"code":2075,"language":676,"meta":95,"style":95},"import { createCanvas, loadImage } from \"canvas\";\n\nasync function loadImageAndConvertToHashWithCanvas(\n  buffer: Buffer\n) {\n  const maxSize = 100;\n  // load image\n  const image = await loadImage(buffer);\n  const width = image.width;\n  const height = image.height;\n  // calculate new size\n  const scale = Math.min(maxSize / width, maxSize / height);\n  const resizedWidth = Math.floor(width * scale);\n  const resizedHeight = Math.floor(height * scale);\n  // create thumb with new size\n  const canvas = createCanvas(resizedWidth, resizedHeight);\n  const ctx = canvas.getContext(\"2d\");\n  ctx.drawImage(image, 0, 0, resizedWidth, resizedHeight);\n  // get pixels array\n  const imageData = ctx.getImageData(0, 0, resizedWidth, resizedHeight);\n  const rgba = new Uint8Array(imageData.data.buffer);\n  // generate thumbhash\n  const hash = rgbaToThumbHash(resizedWidth, resizedHeight, rgba);\n  // convert it to base64\n  const base64 = Buffer.from(hash).toString('base64');\n  return base64;\n}\n",[22,2077,2078,2092,2096,2107,2117,2121,2135,2140,2156,2168,2180,2185,2212,2235,2255,2260,2274,2294,2313,2318,2342,2359,2364,2377,2382,2408,2415],{"__ignoreMap":95},[99,2079,2080,2082,2085,2087,2090],{"class":101,"line":102},[99,2081,106],{"class":105},[99,2083,2084],{"class":109}," { createCanvas, loadImage } ",[99,2086,113],{"class":105},[99,2088,2089],{"class":116}," \"canvas\"",[99,2091,120],{"class":109},[99,2093,2094],{"class":101,"line":123},[99,2095,127],{"emptyLinePlaceholder":126},[99,2097,2098,2100,2102,2105],{"class":101,"line":130},[99,2099,1021],{"class":105},[99,2101,376],{"class":105},[99,2103,2104],{"class":136}," loadImageAndConvertToHashWithCanvas",[99,2106,437],{"class":109},[99,2108,2109,2112,2114],{"class":101,"line":166},[99,2110,2111],{"class":146},"  buffer",[99,2113,150],{"class":105},[99,2115,2116],{"class":136}," Buffer\n",[99,2118,2119],{"class":101,"line":196},[99,2120,490],{"class":109},[99,2122,2123,2125,2128,2130,2133],{"class":101,"line":215},[99,2124,329],{"class":105},[99,2126,2127],{"class":153}," maxSize",[99,2129,140],{"class":105},[99,2131,2132],{"class":153}," 100",[99,2134,120],{"class":109},[99,2136,2137],{"class":101,"line":220},[99,2138,2139],{"class":316},"  // load image\n",[99,2141,2142,2144,2147,2149,2151,2153],{"class":101,"line":232},[99,2143,329],{"class":105},[99,2145,2146],{"class":153}," image",[99,2148,140],{"class":105},[99,2150,536],{"class":105},[99,2152,137],{"class":136},[99,2154,2155],{"class":109},"(buffer);\n",[99,2157,2158,2160,2163,2165],{"class":101,"line":237},[99,2159,329],{"class":105},[99,2161,2162],{"class":153}," width",[99,2164,140],{"class":105},[99,2166,2167],{"class":109}," image.width;\n",[99,2169,2170,2172,2175,2177],{"class":101,"line":255},[99,2171,329],{"class":105},[99,2173,2174],{"class":153}," height",[99,2176,140],{"class":105},[99,2178,2179],{"class":109}," image.height;\n",[99,2181,2182],{"class":101,"line":264},[99,2183,2184],{"class":316},"  // calculate new size\n",[99,2186,2187,2189,2192,2194,2196,2199,2202,2204,2207,2209],{"class":101,"line":270},[99,2188,329],{"class":105},[99,2190,2191],{"class":153}," scale",[99,2193,140],{"class":105},[99,2195,803],{"class":109},[99,2197,2198],{"class":136},"min",[99,2200,2201],{"class":109},"(maxSize ",[99,2203,841],{"class":105},[99,2205,2206],{"class":109}," width, maxSize ",[99,2208,841],{"class":105},[99,2210,2211],{"class":109}," height);\n",[99,2213,2214,2216,2219,2221,2223,2226,2229,2232],{"class":101,"line":276},[99,2215,329],{"class":105},[99,2217,2218],{"class":153}," resizedWidth",[99,2220,140],{"class":105},[99,2222,803],{"class":109},[99,2224,2225],{"class":136},"floor",[99,2227,2228],{"class":109},"(width ",[99,2230,2231],{"class":105},"*",[99,2233,2234],{"class":109}," scale);\n",[99,2236,2237,2239,2242,2244,2246,2248,2251,2253],{"class":101,"line":282},[99,2238,329],{"class":105},[99,2240,2241],{"class":153}," resizedHeight",[99,2243,140],{"class":105},[99,2245,803],{"class":109},[99,2247,2225],{"class":136},[99,2249,2250],{"class":109},"(height ",[99,2252,2231],{"class":105},[99,2254,2234],{"class":109},[99,2256,2257],{"class":101,"line":287},[99,2258,2259],{"class":316},"  // create thumb with new size\n",[99,2261,2262,2264,2266,2268,2271],{"class":101,"line":313},[99,2263,329],{"class":105},[99,2265,890],{"class":153},[99,2267,140],{"class":105},[99,2269,2270],{"class":136}," createCanvas",[99,2272,2273],{"class":109},"(resizedWidth, resizedHeight);\n",[99,2275,2276,2278,2281,2283,2285,2287,2289,2292],{"class":101,"line":320},[99,2277,329],{"class":105},[99,2279,2280],{"class":153}," ctx",[99,2282,140],{"class":105},[99,2284,917],{"class":109},[99,2286,920],{"class":136},[99,2288,410],{"class":109},[99,2290,2291],{"class":116},"\"2d\"",[99,2293,416],{"class":109},[99,2295,2296,2299,2301,2304,2306,2308,2310],{"class":101,"line":326},[99,2297,2298],{"class":109},"  ctx.",[99,2300,955],{"class":136},[99,2302,2303],{"class":109},"(image, ",[99,2305,521],{"class":153},[99,2307,396],{"class":109},[99,2309,521],{"class":153},[99,2311,2312],{"class":109},", resizedWidth, resizedHeight);\n",[99,2314,2315],{"class":101,"line":349},[99,2316,2317],{"class":316},"  // get pixels array\n",[99,2319,2320,2322,2325,2327,2330,2332,2334,2336,2338,2340],{"class":101,"line":357},[99,2321,329],{"class":105},[99,2323,2324],{"class":153}," imageData",[99,2326,140],{"class":105},[99,2328,2329],{"class":109}," ctx.",[99,2331,1212],{"class":136},[99,2333,410],{"class":109},[99,2335,521],{"class":153},[99,2337,396],{"class":109},[99,2339,521],{"class":153},[99,2341,2312],{"class":109},[99,2343,2344,2346,2349,2351,2353,2356],{"class":101,"line":362},[99,2345,329],{"class":105},[99,2347,2348],{"class":153}," rgba",[99,2350,140],{"class":105},[99,2352,172],{"class":105},[99,2354,2355],{"class":136}," Uint8Array",[99,2357,2358],{"class":109},"(imageData.data.buffer);\n",[99,2360,2361],{"class":101,"line":367},[99,2362,2363],{"class":316},"  // generate thumbhash\n",[99,2365,2366,2368,2370,2372,2374],{"class":101,"line":385},[99,2367,329],{"class":105},[99,2369,1235],{"class":153},[99,2371,140],{"class":105},[99,2373,1240],{"class":136},[99,2375,2376],{"class":109},"(resizedWidth, resizedHeight, rgba);\n",[99,2378,2379],{"class":101,"line":419},[99,2380,2381],{"class":316},"  // convert it to base64\n",[99,2383,2384,2386,2389,2391,2393,2395,2398,2401,2403,2406],{"class":101,"line":424},[99,2385,329],{"class":105},[99,2387,2388],{"class":153}," base64",[99,2390,140],{"class":105},[99,2392,1981],{"class":109},[99,2394,113],{"class":136},[99,2396,2397],{"class":109},"(hash).",[99,2399,2400],{"class":136},"toString",[99,2402,410],{"class":109},[99,2404,2405],{"class":116},"'base64'",[99,2407,416],{"class":109},[99,2409,2410,2412],{"class":101,"line":440},[99,2411,169],{"class":105},[99,2413,2414],{"class":109}," base64;\n",[99,2416,2417],{"class":101,"line":473},[99,2418,663],{"class":109},[2062,2420,2422],{"id":2421},"generate-thumbhash-on-server-side-using-sharp","При помощи sharp",[15,2424,2425,2426],{},"Так же можно воспользоваться библиотекой ",[22,2427,2428],{},"sharp",[90,2430,2432],{"className":674,"code":2431,"language":676,"meta":95,"style":95},"import sharp from \"sharp\";\n\nconst loadImageAndConvertToHashWithSharp = async (buffer: Buffer) => {\n  // load image\n  const sharpImage = sharp(buffer);\n  const imageMetadata = await sharpImage.metadata();\n  // calculate new size\n  const size = Math.max(imageMetadata.width || 1, imageMetadata.height || 1);\n  const w = Math.round(100 * (imageMetadata.width || 1) / size);\n  const h = Math.round(100 * (imageMetadata.height || 1) / size);\n  // create thumb with new size\n  const { data } = await sharpImage\n    .resize({\n      withoutEnlargement: true,\n      width: w,\n      height: h,\n    })\n    .ensureAlpha() // rgbaToThumbHash require 4 channals\n    .raw()\n    .toBuffer({ resolveWithObject: true });\n  // generate thumbhash\n  const hash = rgbaToThumbHash(w, h, data);\n  // convert it to base64\n  const base64 = Buffer.from(hash).toString('base64');\n  return base64;\n};\n",[22,2433,2434,2448,2452,2479,2483,2497,2516,2520,2550,2581,2612,2616,2636,2646,2656,2661,2666,2671,2684,2694,2709,2713,2726,2730,2752,2758],{"__ignoreMap":95},[99,2435,2436,2438,2441,2443,2446],{"class":101,"line":102},[99,2437,106],{"class":105},[99,2439,2440],{"class":109}," sharp ",[99,2442,113],{"class":105},[99,2444,2445],{"class":116}," \"sharp\"",[99,2447,120],{"class":109},[99,2449,2450],{"class":101,"line":123},[99,2451,127],{"emptyLinePlaceholder":126},[99,2453,2454,2456,2459,2461,2463,2465,2468,2470,2473,2475,2477],{"class":101,"line":130},[99,2455,133],{"class":105},[99,2457,2458],{"class":136}," loadImageAndConvertToHashWithSharp",[99,2460,140],{"class":105},[99,2462,1821],{"class":105},[99,2464,143],{"class":109},[99,2466,2467],{"class":146},"buffer",[99,2469,150],{"class":105},[99,2471,2472],{"class":136}," Buffer",[99,2474,157],{"class":109},[99,2476,160],{"class":105},[99,2478,163],{"class":109},[99,2480,2481],{"class":101,"line":166},[99,2482,2139],{"class":316},[99,2484,2485,2487,2490,2492,2495],{"class":101,"line":196},[99,2486,329],{"class":105},[99,2488,2489],{"class":153}," sharpImage",[99,2491,140],{"class":105},[99,2493,2494],{"class":136}," sharp",[99,2496,2155],{"class":109},[99,2498,2499,2501,2504,2506,2508,2511,2514],{"class":101,"line":215},[99,2500,329],{"class":105},[99,2502,2503],{"class":153}," imageMetadata",[99,2505,140],{"class":105},[99,2507,536],{"class":105},[99,2509,2510],{"class":109}," sharpImage.",[99,2512,2513],{"class":136},"metadata",[99,2515,212],{"class":109},[99,2517,2518],{"class":101,"line":220},[99,2519,2184],{"class":316},[99,2521,2522,2524,2526,2528,2530,2532,2535,2538,2541,2544,2546,2548],{"class":101,"line":232},[99,2523,329],{"class":105},[99,2525,798],{"class":153},[99,2527,140],{"class":105},[99,2529,803],{"class":109},[99,2531,806],{"class":136},[99,2533,2534],{"class":109},"(imageMetadata.width ",[99,2536,2537],{"class":105},"||",[99,2539,2540],{"class":153}," 1",[99,2542,2543],{"class":109},", imageMetadata.height ",[99,2545,2537],{"class":105},[99,2547,2540],{"class":153},[99,2549,416],{"class":109},[99,2551,2552,2554,2556,2558,2560,2562,2564,2566,2568,2571,2573,2575,2577,2579],{"class":101,"line":237},[99,2553,329],{"class":105},[99,2555,816],{"class":153},[99,2557,140],{"class":105},[99,2559,803],{"class":109},[99,2561,828],{"class":136},[99,2563,410],{"class":109},[99,2565,833],{"class":153},[99,2567,836],{"class":105},[99,2569,2570],{"class":109}," (imageMetadata.width ",[99,2572,2537],{"class":105},[99,2574,2540],{"class":153},[99,2576,157],{"class":109},[99,2578,841],{"class":105},[99,2580,844],{"class":109},[99,2582,2583,2585,2587,2589,2591,2593,2595,2597,2599,2602,2604,2606,2608,2610],{"class":101,"line":255},[99,2584,329],{"class":105},[99,2586,851],{"class":153},[99,2588,140],{"class":105},[99,2590,803],{"class":109},[99,2592,828],{"class":136},[99,2594,410],{"class":109},[99,2596,833],{"class":153},[99,2598,836],{"class":105},[99,2600,2601],{"class":109}," (imageMetadata.height ",[99,2603,2537],{"class":105},[99,2605,2540],{"class":153},[99,2607,157],{"class":109},[99,2609,841],{"class":105},[99,2611,844],{"class":109},[99,2613,2614],{"class":101,"line":264},[99,2615,2259],{"class":316},[99,2617,2618,2620,2623,2626,2629,2631,2633],{"class":101,"line":270},[99,2619,329],{"class":105},[99,2621,2622],{"class":109}," { ",[99,2624,2625],{"class":153},"data",[99,2627,2628],{"class":109}," } ",[99,2630,226],{"class":105},[99,2632,536],{"class":105},[99,2634,2635],{"class":109}," sharpImage\n",[99,2637,2638,2641,2644],{"class":101,"line":276},[99,2639,2640],{"class":109},"    .",[99,2642,2643],{"class":136},"resize",[99,2645,1915],{"class":109},[99,2647,2648,2651,2654],{"class":101,"line":282},[99,2649,2650],{"class":109},"      withoutEnlargement: ",[99,2652,2653],{"class":153},"true",[99,2655,1357],{"class":109},[99,2657,2658],{"class":101,"line":287},[99,2659,2660],{"class":109},"      width: w,\n",[99,2662,2663],{"class":101,"line":313},[99,2664,2665],{"class":109},"      height: h,\n",[99,2667,2668],{"class":101,"line":320},[99,2669,2670],{"class":109},"    })\n",[99,2672,2673,2675,2678,2681],{"class":101,"line":326},[99,2674,2640],{"class":109},[99,2676,2677],{"class":136},"ensureAlpha",[99,2679,2680],{"class":109},"() ",[99,2682,2683],{"class":316},"// rgbaToThumbHash require 4 channals\n",[99,2685,2686,2688,2691],{"class":101,"line":349},[99,2687,2640],{"class":109},[99,2689,2690],{"class":136},"raw",[99,2692,2693],{"class":109},"()\n",[99,2695,2696,2698,2701,2704,2706],{"class":101,"line":357},[99,2697,2640],{"class":109},[99,2699,2700],{"class":136},"toBuffer",[99,2702,2703],{"class":109},"({ resolveWithObject: ",[99,2705,2653],{"class":153},[99,2707,2708],{"class":109}," });\n",[99,2710,2711],{"class":101,"line":362},[99,2712,2363],{"class":316},[99,2714,2715,2717,2719,2721,2723],{"class":101,"line":367},[99,2716,329],{"class":105},[99,2718,1235],{"class":153},[99,2720,140],{"class":105},[99,2722,1240],{"class":136},[99,2724,2725],{"class":109},"(w, h, data);\n",[99,2727,2728],{"class":101,"line":385},[99,2729,2381],{"class":316},[99,2731,2732,2734,2736,2738,2740,2742,2744,2746,2748,2750],{"class":101,"line":419},[99,2733,329],{"class":105},[99,2735,2388],{"class":153},[99,2737,140],{"class":105},[99,2739,1981],{"class":109},[99,2741,113],{"class":136},[99,2743,2397],{"class":109},[99,2745,2400],{"class":136},[99,2747,410],{"class":109},[99,2749,2405],{"class":116},[99,2751,416],{"class":109},[99,2753,2754,2756],{"class":101,"line":424},[99,2755,169],{"class":105},[99,2757,2414],{"class":109},[99,2759,2760],{"class":101,"line":440},[99,2761,279],{"class":109},[2763,2764,2765],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .szBVR, html code.shiki .szBVR{--shiki-default:#D73A49;--shiki-dark:#F97583}html pre.shiki code .sVt8B, html code.shiki .sVt8B{--shiki-default:#24292E;--shiki-dark:#E1E4E8}html pre.shiki code .sZZnC, html code.shiki .sZZnC{--shiki-default:#032F62;--shiki-dark:#9ECBFF}html pre.shiki code .sScJk, html code.shiki .sScJk{--shiki-default:#6F42C1;--shiki-dark:#B392F0}html pre.shiki code .s4XuR, html code.shiki .s4XuR{--shiki-default:#E36209;--shiki-dark:#FFAB70}html pre.shiki code .sj4cs, html code.shiki .sj4cs{--shiki-default:#005CC5;--shiki-dark:#79B8FF}html pre.shiki code .sJ8bj, html code.shiki .sJ8bj{--shiki-default:#6A737D;--shiki-dark:#6A737D}html pre.shiki code .s9eBZ, html code.shiki .s9eBZ{--shiki-default:#22863A;--shiki-dark:#85E89D}",{"title":95,"searchDepth":123,"depth":123,"links":2767},[2768,2769,2770],{"id":12,"depth":123,"text":13},{"id":77,"depth":123,"text":78},{"id":1797,"depth":123,"text":1798,"children":2771},[2772,2773],{"id":2064,"depth":130,"text":2065},{"id":2421,"depth":130,"text":2422},"2024-01-22","Прогрессивная загрузка изображений при помощи создания миниатюр в thumbhash и их использование в React","md",{},"/blog/progressive-images-using-thumbhash","/images/image-thumb-preview.webp",{"title":5,"description":2775},"blog/progressive-images-using-thumbhash",[2783,2784,2785],"images","react","node.js","3LPPKEE8XZT4UIR2vkmVIVrk9_jr5rlo_-Di3FuX-KE",[2788,2792],{"title":2789,"path":2790,"stem":2791,"children":-1},"Шпаргалка по built-in методам","/blog/js-built-in-methods","blog/js-built-in-methods",{"title":2793,"path":2794,"stem":2795,"children":-1},"Почему ленивец?","/blog/why-sloth","blog/why-sloth",1751114697591]