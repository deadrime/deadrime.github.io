[{"data":1,"prerenderedAt":2788},["ShallowReactive",2],{"articles_images":3},[4],{"id":5,"title":6,"body":7,"date":2775,"description":2776,"extension":2777,"meta":2778,"navigation":127,"path":2779,"previewImg":2780,"seo":2781,"stem":2782,"topics":2783,"__hash__":2787},"articles/blog/progressive-images-using-thumbhash.md","Progressive images при помощи base64 миниатюр",{"type":8,"value":9,"toc":2767},"minimark",[10,15,19,31,34,41,49,52,58,61,67,76,80,83,90,665,668,673,782,788,969,983,994,1288,1291,1302,1305,1330,1333,1403,1406,1511,1514,1796,1800,1811,2062,2067,2074,2420,2424,2430,2763],[11,12,14],"h2",{"id":13},"why","Зачем оно вообще нужно",[16,17,18],"p",{},"Для начала поговорим про цифры. Если вы когда-нибудь делали аналитику сайта - то вы в курсе, что изображения весьма прожорливые. Скорее всего даже более прожорливые, чем ваш бандл.\nПеред тем, как пытаться оптимизировать что-либо еще - лучше начать именно с картинок.",[16,20,21,22,26,27,30],{},"Однако даже если использовать ",[23,24,25],"code",{},"WEBP"," или ",[23,28,29],{},"AVIF"," - картинки все равно будут весить неприлично много.\nОсобенно если их много.\nПри этом всегда стоит держать в голове, что среднестатистический пользователь вашего сайта скорее всего зайдет с мобильного телефона.\nИ у него вряд ли будет быстрый мобильный интернет. А медленный интернет накладывает свои ограничения:",[16,32,33],{},"UI может прыгать, пока все картинки не загрузятся (сделаем допущение, что вы не хотите или не можете привести все картинки к одному размеру)\nПри медленном интернете или если сервер слишком далеко от пользователя, он будет видеть огрызки картинок, что прямо скажем не красиво.",[16,35,36],{},[37,38],"img",{"alt":39,"src":40},"Раздражает, правда?","https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNXJtZTh4dGJ2bDBiMnVuZHJkMmc2cWQxZzFkdGdzOXJxYjdhbGYzbSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/QIQTfximd3AuQ/giphy.gif",[16,42,43,44,48],{},"А еще пользователь у нас очень привередливый и если мы не покажем ему хоть что-то в течении первых пары секунд - скорее всего мы его потеряем.\nИменно проблему ",[45,46,47],"strong",{},"показать хоть что-то"," и призвана решить прогрессивная загрузка изображений.",[16,50,51],{},"Идея заключается в том, что мы показываем пользователю миниатюру в низком разрешении, пока грузим оригинальную картинку.",[16,53,54],{},[37,55],{"alt":56,"src":57},"Пример из telegram","/images/progressive-images-using-thumbhash/telegram-example.png",[16,59,60],{},"Для реализации такого подхода я выбрал либу thumbhash, она весит \u003C 4kb и позволяет хранить хеш весом всего 30-40 байт.",[62,63],"code-example",{"height":64,"open-file":65,"project-id":66},600,"ProgressiveImageExample.tsx","react-ts-c9v55cdz",[16,68,69,70],{},"Еще примеры можно найти на официальном сайте: ",[71,72,73],"a",{"href":73,"rel":74},"https://evanw.github.io/thumbhash/",[75],"nofollow",[11,77,79],{"id":78},"generate-thumbhash-on-client-side","Генерация thumbhash на клиенте",[16,81,82],{},"Рассмотрим кейс, когда пользователь создает новый пост и сам загружает изображение. В этом случае сгенерировать thumb можно прямо на клиенте.",[16,84,85,86,89],{},"Для начала загрузка изображения - тут все стандартно, подписываемся на ",[23,87,88],{},"onChange"," у инпута и достаем оттуда файл",[91,92,97],"pre",{"className":93,"code":94,"language":95,"meta":96,"style":96},"language-tsx shiki shiki-themes github-light github-dark","import { useCallback, useState } from \"react\";\n\nconst loadImage = (imageUrl: string) => {\n  return new Promise\u003CHTMLImageElement>((resolve) => {\n    const img = new Image();\n\n    img.src = imageUrl;\n\n    img.onload = () => {\n      resolve(img);\n    };\n  });\n};\n\nconst getImageUrl = (file: File) => {\n  // You can implement your own upload logic here\n  // For example we just create url on client-side\n  const url = URL.createObjectURL(file); \n  return url;\n};\n\nexport default function App() {\n  const [originalImageSrc, setOriginalImageSrc] = useState(\"\");\n\n  const handleFileUpload = useCallback(\n    async (event: React.ChangeEvent\u003CHTMLInputElement>) => {\n      if (!event.target.files?.length) {\n        return;\n      }\n      const file = event.target.files[0];\n      const url = await getImageUrl(file);\n      setOriginalImageSrc(url);\n    },\n    []\n  );\n\n  return (\n    \u003Cdiv className=\"App\">\n      \u003Cinput type=\"file\" onChange={handleFileUpload} />\n      \u003Cimg src={originalImageSrc} />\n    \u003C/div>\n  );\n}\n","tsx","",[23,98,99,122,129,165,195,214,219,231,236,254,263,269,275,281,286,312,319,325,348,356,361,366,384,418,423,439,472,492,500,506,526,543,552,558,564,570,575,583,604,629,644,654,659],{"__ignoreMap":96},[100,101,104,108,112,115,119],"span",{"class":102,"line":103},"line",1,[100,105,107],{"class":106},"szBVR","import",[100,109,111],{"class":110},"sVt8B"," { useCallback, useState } ",[100,113,114],{"class":106},"from",[100,116,118],{"class":117},"sZZnC"," \"react\"",[100,120,121],{"class":110},";\n",[100,123,125],{"class":102,"line":124},2,[100,126,128],{"emptyLinePlaceholder":127},true,"\n",[100,130,132,135,139,142,145,149,152,156,159,162],{"class":102,"line":131},3,[100,133,134],{"class":106},"const",[100,136,138],{"class":137},"sScJk"," loadImage",[100,140,141],{"class":106}," =",[100,143,144],{"class":110}," (",[100,146,148],{"class":147},"s4XuR","imageUrl",[100,150,151],{"class":106},":",[100,153,155],{"class":154},"sj4cs"," string",[100,157,158],{"class":110},") ",[100,160,161],{"class":106},"=>",[100,163,164],{"class":110}," {\n",[100,166,168,171,174,177,180,183,186,189,191,193],{"class":102,"line":167},4,[100,169,170],{"class":106},"  return",[100,172,173],{"class":106}," new",[100,175,176],{"class":154}," Promise",[100,178,179],{"class":110},"\u003C",[100,181,182],{"class":137},"HTMLImageElement",[100,184,185],{"class":110},">((",[100,187,188],{"class":147},"resolve",[100,190,158],{"class":110},[100,192,161],{"class":106},[100,194,164],{"class":110},[100,196,198,201,204,206,208,211],{"class":102,"line":197},5,[100,199,200],{"class":106},"    const",[100,202,203],{"class":154}," img",[100,205,141],{"class":106},[100,207,173],{"class":106},[100,209,210],{"class":137}," Image",[100,212,213],{"class":110},"();\n",[100,215,217],{"class":102,"line":216},6,[100,218,128],{"emptyLinePlaceholder":127},[100,220,222,225,228],{"class":102,"line":221},7,[100,223,224],{"class":110},"    img.src ",[100,226,227],{"class":106},"=",[100,229,230],{"class":110}," imageUrl;\n",[100,232,234],{"class":102,"line":233},8,[100,235,128],{"emptyLinePlaceholder":127},[100,237,239,242,245,247,250,252],{"class":102,"line":238},9,[100,240,241],{"class":110},"    img.",[100,243,244],{"class":137},"onload",[100,246,141],{"class":106},[100,248,249],{"class":110}," () ",[100,251,161],{"class":106},[100,253,164],{"class":110},[100,255,257,260],{"class":102,"line":256},10,[100,258,259],{"class":137},"      resolve",[100,261,262],{"class":110},"(img);\n",[100,264,266],{"class":102,"line":265},11,[100,267,268],{"class":110},"    };\n",[100,270,272],{"class":102,"line":271},12,[100,273,274],{"class":110},"  });\n",[100,276,278],{"class":102,"line":277},13,[100,279,280],{"class":110},"};\n",[100,282,284],{"class":102,"line":283},14,[100,285,128],{"emptyLinePlaceholder":127},[100,287,289,291,294,296,298,301,303,306,308,310],{"class":102,"line":288},15,[100,290,134],{"class":106},[100,292,293],{"class":137}," getImageUrl",[100,295,141],{"class":106},[100,297,144],{"class":110},[100,299,300],{"class":147},"file",[100,302,151],{"class":106},[100,304,305],{"class":137}," File",[100,307,158],{"class":110},[100,309,161],{"class":106},[100,311,164],{"class":110},[100,313,315],{"class":102,"line":314},16,[100,316,318],{"class":317},"sJ8bj","  // You can implement your own upload logic here\n",[100,320,322],{"class":102,"line":321},17,[100,323,324],{"class":317},"  // For example we just create url on client-side\n",[100,326,328,331,334,336,339,342,345],{"class":102,"line":327},18,[100,329,330],{"class":106},"  const",[100,332,333],{"class":154}," url",[100,335,141],{"class":106},[100,337,338],{"class":154}," URL",[100,340,341],{"class":110},".",[100,343,344],{"class":137},"createObjectURL",[100,346,347],{"class":110},"(file); \n",[100,349,351,353],{"class":102,"line":350},19,[100,352,170],{"class":106},[100,354,355],{"class":110}," url;\n",[100,357,359],{"class":102,"line":358},20,[100,360,280],{"class":110},[100,362,364],{"class":102,"line":363},21,[100,365,128],{"emptyLinePlaceholder":127},[100,367,369,372,375,378,381],{"class":102,"line":368},22,[100,370,371],{"class":106},"export",[100,373,374],{"class":106}," default",[100,376,377],{"class":106}," function",[100,379,380],{"class":137}," App",[100,382,383],{"class":110},"() {\n",[100,385,387,389,392,395,398,401,404,406,409,412,415],{"class":102,"line":386},23,[100,388,330],{"class":106},[100,390,391],{"class":110}," [",[100,393,394],{"class":154},"originalImageSrc",[100,396,397],{"class":110},", ",[100,399,400],{"class":154},"setOriginalImageSrc",[100,402,403],{"class":110},"] ",[100,405,227],{"class":106},[100,407,408],{"class":137}," useState",[100,410,411],{"class":110},"(",[100,413,414],{"class":117},"\"\"",[100,416,417],{"class":110},");\n",[100,419,421],{"class":102,"line":420},24,[100,422,128],{"emptyLinePlaceholder":127},[100,424,426,428,431,433,436],{"class":102,"line":425},25,[100,427,330],{"class":106},[100,429,430],{"class":154}," handleFileUpload",[100,432,141],{"class":106},[100,434,435],{"class":137}," useCallback",[100,437,438],{"class":110},"(\n",[100,440,442,445,447,450,452,455,457,460,462,465,468,470],{"class":102,"line":441},26,[100,443,444],{"class":106},"    async",[100,446,144],{"class":110},[100,448,449],{"class":147},"event",[100,451,151],{"class":106},[100,453,454],{"class":137}," React",[100,456,341],{"class":110},[100,458,459],{"class":137},"ChangeEvent",[100,461,179],{"class":110},[100,463,464],{"class":137},"HTMLInputElement",[100,466,467],{"class":110},">) ",[100,469,161],{"class":106},[100,471,164],{"class":110},[100,473,475,478,480,483,486,489],{"class":102,"line":474},27,[100,476,477],{"class":106},"      if",[100,479,144],{"class":110},[100,481,482],{"class":106},"!",[100,484,485],{"class":110},"event.target.files?.",[100,487,488],{"class":154},"length",[100,490,491],{"class":110},") {\n",[100,493,495,498],{"class":102,"line":494},28,[100,496,497],{"class":106},"        return",[100,499,121],{"class":110},[100,501,503],{"class":102,"line":502},29,[100,504,505],{"class":110},"      }\n",[100,507,509,512,515,517,520,523],{"class":102,"line":508},30,[100,510,511],{"class":106},"      const",[100,513,514],{"class":154}," file",[100,516,141],{"class":106},[100,518,519],{"class":110}," event.target.files[",[100,521,522],{"class":154},"0",[100,524,525],{"class":110},"];\n",[100,527,529,531,533,535,538,540],{"class":102,"line":528},31,[100,530,511],{"class":106},[100,532,333],{"class":154},[100,534,141],{"class":106},[100,536,537],{"class":106}," await",[100,539,293],{"class":137},[100,541,542],{"class":110},"(file);\n",[100,544,546,549],{"class":102,"line":545},32,[100,547,548],{"class":137},"      setOriginalImageSrc",[100,550,551],{"class":110},"(url);\n",[100,553,555],{"class":102,"line":554},33,[100,556,557],{"class":110},"    },\n",[100,559,561],{"class":102,"line":560},34,[100,562,563],{"class":110},"    []\n",[100,565,567],{"class":102,"line":566},35,[100,568,569],{"class":110},"  );\n",[100,571,573],{"class":102,"line":572},36,[100,574,128],{"emptyLinePlaceholder":127},[100,576,578,580],{"class":102,"line":577},37,[100,579,170],{"class":106},[100,581,582],{"class":110}," (\n",[100,584,586,589,593,596,598,601],{"class":102,"line":585},38,[100,587,588],{"class":110},"    \u003C",[100,590,592],{"class":591},"s9eBZ","div",[100,594,595],{"class":137}," className",[100,597,227],{"class":106},[100,599,600],{"class":117},"\"App\"",[100,602,603],{"class":110},">\n",[100,605,607,610,613,616,618,621,624,626],{"class":102,"line":606},39,[100,608,609],{"class":110},"      \u003C",[100,611,612],{"class":591},"input",[100,614,615],{"class":137}," type",[100,617,227],{"class":106},[100,619,620],{"class":117},"\"file\"",[100,622,623],{"class":137}," onChange",[100,625,227],{"class":106},[100,627,628],{"class":110},"{handleFileUpload} />\n",[100,630,632,634,636,639,641],{"class":102,"line":631},40,[100,633,609],{"class":110},[100,635,37],{"class":591},[100,637,638],{"class":137}," src",[100,640,227],{"class":106},[100,642,643],{"class":110},"{originalImageSrc} />\n",[100,645,647,650,652],{"class":102,"line":646},41,[100,648,649],{"class":110},"    \u003C/",[100,651,592],{"class":591},[100,653,603],{"class":110},[100,655,657],{"class":102,"line":656},42,[100,658,569],{"class":110},[100,660,662],{"class":102,"line":661},43,[100,663,664],{"class":110},"}\n",[16,666,667],{},"Теперь нам необходимо считать файл как картинку, чтобы создать миниатюру.",[16,669,670,671],{},"Для этого напишем небольшой хелпер, который загружает картинку по переданному url и возвращает ",[23,672,182],{},[91,674,678],{"className":675,"code":676,"language":677,"meta":96,"style":96},"language-ts shiki shiki-themes github-light github-dark","const loadImage = (imageUrl: string) => {\n  return new Promise\u003CHTMLImageElement>((resolve) => {\n    const img = new Image();\n    img.src = imageUrl;\n\n    img.onload = () => {\n      resolve(img);\n    };\n  });\n};\n","ts",[23,679,680,702,724,738,746,750,764,770,774,778],{"__ignoreMap":96},[100,681,682,684,686,688,690,692,694,696,698,700],{"class":102,"line":103},[100,683,134],{"class":106},[100,685,138],{"class":137},[100,687,141],{"class":106},[100,689,144],{"class":110},[100,691,148],{"class":147},[100,693,151],{"class":106},[100,695,155],{"class":154},[100,697,158],{"class":110},[100,699,161],{"class":106},[100,701,164],{"class":110},[100,703,704,706,708,710,712,714,716,718,720,722],{"class":102,"line":124},[100,705,170],{"class":106},[100,707,173],{"class":106},[100,709,176],{"class":154},[100,711,179],{"class":110},[100,713,182],{"class":137},[100,715,185],{"class":110},[100,717,188],{"class":147},[100,719,158],{"class":110},[100,721,161],{"class":106},[100,723,164],{"class":110},[100,725,726,728,730,732,734,736],{"class":102,"line":131},[100,727,200],{"class":106},[100,729,203],{"class":154},[100,731,141],{"class":106},[100,733,173],{"class":106},[100,735,210],{"class":137},[100,737,213],{"class":110},[100,739,740,742,744],{"class":102,"line":167},[100,741,224],{"class":110},[100,743,227],{"class":106},[100,745,230],{"class":110},[100,747,748],{"class":102,"line":197},[100,749,128],{"emptyLinePlaceholder":127},[100,751,752,754,756,758,760,762],{"class":102,"line":216},[100,753,241],{"class":110},[100,755,244],{"class":137},[100,757,141],{"class":106},[100,759,249],{"class":110},[100,761,161],{"class":106},[100,763,164],{"class":110},[100,765,766,768],{"class":102,"line":221},[100,767,259],{"class":137},[100,769,262],{"class":110},[100,771,772],{"class":102,"line":233},[100,773,268],{"class":110},[100,775,776],{"class":102,"line":238},[100,777,274],{"class":110},[100,779,780],{"class":102,"line":256},[100,781,280],{"class":110},[16,783,784,785,151],{},"Теперь необходимо создать миниатюру изображения, для этого воспользуемся ",[23,786,787],{},"canvas",[91,789,791],{"className":675,"code":790,"language":677,"meta":96,"style":96},"const size = Math.max(img.width, img.height);\nconst w = img.width = Math.round(100 * img.width / size);\nconst h = img.height = Math.round(100 * img.height / size);\n\n// Create image thumb (100x100 maximum size)\nconst canvas = document.createElement('canvas');\nconst c = canvas.getContext('2d');\ncanvas.width = w;\ncanvas.height = h;\nc.drawImage(img, 0, 0, w, h);\n",[23,792,793,811,846,876,880,885,907,929,939,949],{"__ignoreMap":96},[100,794,795,797,800,802,805,808],{"class":102,"line":103},[100,796,134],{"class":106},[100,798,799],{"class":154}," size",[100,801,141],{"class":106},[100,803,804],{"class":110}," Math.",[100,806,807],{"class":137},"max",[100,809,810],{"class":110},"(img.width, img.height);\n",[100,812,813,815,818,820,823,825,827,830,832,835,838,840,843],{"class":102,"line":124},[100,814,134],{"class":106},[100,816,817],{"class":154}," w",[100,819,141],{"class":106},[100,821,822],{"class":110}," img.width ",[100,824,227],{"class":106},[100,826,804],{"class":110},[100,828,829],{"class":137},"round",[100,831,411],{"class":110},[100,833,834],{"class":154},"100",[100,836,837],{"class":106}," *",[100,839,822],{"class":110},[100,841,842],{"class":106},"/",[100,844,845],{"class":110}," size);\n",[100,847,848,850,853,855,858,860,862,864,866,868,870,872,874],{"class":102,"line":131},[100,849,134],{"class":106},[100,851,852],{"class":154}," h",[100,854,141],{"class":106},[100,856,857],{"class":110}," img.height ",[100,859,227],{"class":106},[100,861,804],{"class":110},[100,863,829],{"class":137},[100,865,411],{"class":110},[100,867,834],{"class":154},[100,869,837],{"class":106},[100,871,857],{"class":110},[100,873,842],{"class":106},[100,875,845],{"class":110},[100,877,878],{"class":102,"line":167},[100,879,128],{"emptyLinePlaceholder":127},[100,881,882],{"class":102,"line":197},[100,883,884],{"class":317},"// Create image thumb (100x100 maximum size)\n",[100,886,887,889,892,894,897,900,902,905],{"class":102,"line":216},[100,888,134],{"class":106},[100,890,891],{"class":154}," canvas",[100,893,141],{"class":106},[100,895,896],{"class":110}," document.",[100,898,899],{"class":137},"createElement",[100,901,411],{"class":110},[100,903,904],{"class":117},"'canvas'",[100,906,417],{"class":110},[100,908,909,911,914,916,919,922,924,927],{"class":102,"line":221},[100,910,134],{"class":106},[100,912,913],{"class":154}," c",[100,915,141],{"class":106},[100,917,918],{"class":110}," canvas.",[100,920,921],{"class":137},"getContext",[100,923,411],{"class":110},[100,925,926],{"class":117},"'2d'",[100,928,417],{"class":110},[100,930,931,934,936],{"class":102,"line":233},[100,932,933],{"class":110},"canvas.width ",[100,935,227],{"class":106},[100,937,938],{"class":110}," w;\n",[100,940,941,944,946],{"class":102,"line":238},[100,942,943],{"class":110},"canvas.height ",[100,945,227],{"class":106},[100,947,948],{"class":110}," h;\n",[100,950,951,954,957,960,962,964,966],{"class":102,"line":256},[100,952,953],{"class":110},"c.",[100,955,956],{"class":137},"drawImage",[100,958,959],{"class":110},"(img, ",[100,961,522],{"class":154},[100,963,397],{"class":110},[100,965,522],{"class":154},[100,967,968],{"class":110},", w, h);\n",[16,970,971,972,979,980,341],{},"После чего достаем из полученной миниатюры ",[71,973,976],{"href":974,"rel":975},"https://developer.mozilla.org/en-US/docs/Web/API/ImageData",[75],[23,977,978],{},"ImageData"," и скармливаем полученный массив пикселей методу ",[23,981,982],{},"rgbaToThumbHash",[16,984,985,986,989,990,993],{},"Полученный ",[45,987,988],{},"Uint8Array"," я конвертирую в ",[45,991,992],{},"base64"," строку, которую мы затем можем сохранить на сервере.",[91,995,998],{"className":675,"code":996,"highlights":997,"language":677,"meta":96,"style":96},"import { rgbaToThumbHash } from 'thumbhash';\n\nasync function generateImageThumb(img: HTMLImageElement) {\n  const size = Math.max(img.width, img.height);\n  const w = img.width = Math.round(100 * img.width / size);\n  const h = img.height = Math.round(100 * img.height / size);\n\n  // // Create image thumb (100x100 maximum size)\n  const canvas = document.createElement('canvas');\n  const c = canvas.getContext('2d');\n  canvas.width = w;\n  canvas.height = h;\n  c.drawImage(img, 0, 0, w, h);\n  // Get pixels array\n  const pixels = c.getImageData(0, 0, w, h);\n  // Get thumbhash (Uint8Array)\n  const hash = rgbaToThumbHash(w, h, pixels.data);\n  // convert Uint8Array to base64 string\n  const binString = String.fromCodePoint(...hash);\n  return btoa(binString);\n}\n",[288,321,350],[23,999,1000,1014,1018,1039,1053,1081,1109,1113,1121,1139,1157,1166,1175,1192,1197,1224,1229,1245,1250,1274,1284],{"__ignoreMap":96},[100,1001,1002,1004,1007,1009,1012],{"class":102,"line":103},[100,1003,107],{"class":106},[100,1005,1006],{"class":110}," { rgbaToThumbHash } ",[100,1008,114],{"class":106},[100,1010,1011],{"class":117}," 'thumbhash'",[100,1013,121],{"class":110},[100,1015,1016],{"class":102,"line":124},[100,1017,128],{"emptyLinePlaceholder":127},[100,1019,1020,1023,1025,1028,1030,1032,1034,1037],{"class":102,"line":131},[100,1021,1022],{"class":106},"async",[100,1024,377],{"class":106},[100,1026,1027],{"class":137}," generateImageThumb",[100,1029,411],{"class":110},[100,1031,37],{"class":147},[100,1033,151],{"class":106},[100,1035,1036],{"class":137}," HTMLImageElement",[100,1038,491],{"class":110},[100,1040,1041,1043,1045,1047,1049,1051],{"class":102,"line":167},[100,1042,330],{"class":106},[100,1044,799],{"class":154},[100,1046,141],{"class":106},[100,1048,804],{"class":110},[100,1050,807],{"class":137},[100,1052,810],{"class":110},[100,1054,1055,1057,1059,1061,1063,1065,1067,1069,1071,1073,1075,1077,1079],{"class":102,"line":197},[100,1056,330],{"class":106},[100,1058,817],{"class":154},[100,1060,141],{"class":106},[100,1062,822],{"class":110},[100,1064,227],{"class":106},[100,1066,804],{"class":110},[100,1068,829],{"class":137},[100,1070,411],{"class":110},[100,1072,834],{"class":154},[100,1074,837],{"class":106},[100,1076,822],{"class":110},[100,1078,842],{"class":106},[100,1080,845],{"class":110},[100,1082,1083,1085,1087,1089,1091,1093,1095,1097,1099,1101,1103,1105,1107],{"class":102,"line":216},[100,1084,330],{"class":106},[100,1086,852],{"class":154},[100,1088,141],{"class":106},[100,1090,857],{"class":110},[100,1092,227],{"class":106},[100,1094,804],{"class":110},[100,1096,829],{"class":137},[100,1098,411],{"class":110},[100,1100,834],{"class":154},[100,1102,837],{"class":106},[100,1104,857],{"class":110},[100,1106,842],{"class":106},[100,1108,845],{"class":110},[100,1110,1111],{"class":102,"line":221},[100,1112,128],{"emptyLinePlaceholder":127},[100,1114,1115,1118],{"class":102,"line":233},[100,1116,1117],{"class":317},"  //",[100,1119,1120],{"class":317}," // Create image thumb (100x100 maximum size)\n",[100,1122,1123,1125,1127,1129,1131,1133,1135,1137],{"class":102,"line":238},[100,1124,330],{"class":106},[100,1126,891],{"class":154},[100,1128,141],{"class":106},[100,1130,896],{"class":110},[100,1132,899],{"class":137},[100,1134,411],{"class":110},[100,1136,904],{"class":117},[100,1138,417],{"class":110},[100,1140,1141,1143,1145,1147,1149,1151,1153,1155],{"class":102,"line":256},[100,1142,330],{"class":106},[100,1144,913],{"class":154},[100,1146,141],{"class":106},[100,1148,918],{"class":110},[100,1150,921],{"class":137},[100,1152,411],{"class":110},[100,1154,926],{"class":117},[100,1156,417],{"class":110},[100,1158,1159,1162,1164],{"class":102,"line":265},[100,1160,1161],{"class":110},"  canvas.width ",[100,1163,227],{"class":106},[100,1165,938],{"class":110},[100,1167,1168,1171,1173],{"class":102,"line":271},[100,1169,1170],{"class":110},"  canvas.height ",[100,1172,227],{"class":106},[100,1174,948],{"class":110},[100,1176,1177,1180,1182,1184,1186,1188,1190],{"class":102,"line":277},[100,1178,1179],{"class":110},"  c.",[100,1181,956],{"class":137},[100,1183,959],{"class":110},[100,1185,522],{"class":154},[100,1187,397],{"class":110},[100,1189,522],{"class":154},[100,1191,968],{"class":110},[100,1193,1194],{"class":102,"line":283},[100,1195,1196],{"class":317},"  // Get pixels array\n",[100,1198,1201,1203,1206,1208,1211,1214,1216,1218,1220,1222],{"class":1199,"line":288},[102,1200],"highlight",[100,1202,330],{"class":106},[100,1204,1205],{"class":154}," pixels",[100,1207,141],{"class":106},[100,1209,1210],{"class":110}," c.",[100,1212,1213],{"class":137},"getImageData",[100,1215,411],{"class":110},[100,1217,522],{"class":154},[100,1219,397],{"class":110},[100,1221,522],{"class":154},[100,1223,968],{"class":110},[100,1225,1226],{"class":102,"line":314},[100,1227,1228],{"class":317},"  // Get thumbhash (Uint8Array)\n",[100,1230,1232,1234,1237,1239,1242],{"class":1231,"line":321},[102,1200],[100,1233,330],{"class":106},[100,1235,1236],{"class":154}," hash",[100,1238,141],{"class":106},[100,1240,1241],{"class":137}," rgbaToThumbHash",[100,1243,1244],{"class":110},"(w, h, pixels.data);\n",[100,1246,1247],{"class":102,"line":327},[100,1248,1249],{"class":317},"  // convert Uint8Array to base64 string\n",[100,1251,1253,1255,1258,1260,1263,1266,1268,1271],{"class":1252,"line":350},[102,1200],[100,1254,330],{"class":106},[100,1256,1257],{"class":154}," binString",[100,1259,141],{"class":106},[100,1261,1262],{"class":110}," String.",[100,1264,1265],{"class":137},"fromCodePoint",[100,1267,411],{"class":110},[100,1269,1270],{"class":106},"...",[100,1272,1273],{"class":110},"hash);\n",[100,1275,1276,1278,1281],{"class":102,"line":358},[100,1277,170],{"class":106},[100,1279,1280],{"class":137}," btoa",[100,1282,1283],{"class":110},"(binString);\n",[100,1285,1286],{"class":102,"line":363},[100,1287,664],{"class":110},[16,1289,1290],{},"В результате этих махинаций мы получаем такую строку",[91,1292,1296],{"className":1293,"code":1294,"language":1295,"meta":96,"style":96},"language-txt shiki shiki-themes github-light github-dark","0ucJJgoHiHeId5eYV4d3hneYiHiPiPc=\n","txt",[23,1297,1298],{"__ignoreMap":96},[100,1299,1300],{"class":102,"line":103},[100,1301,1294],{},[16,1303,1304],{},"Весит она всего 32 байта",[91,1306,1308],{"className":675,"code":1307,"language":677,"meta":96,"style":96},"new Blob([\"0ucJJgoHiHeId5eYV4d3hneYiHiPiPc=\"]).size; // 32\n",[23,1309,1310],{"__ignoreMap":96},[100,1311,1312,1315,1318,1321,1324,1327],{"class":102,"line":103},[100,1313,1314],{"class":106},"new",[100,1316,1317],{"class":137}," Blob",[100,1319,1320],{"class":110},"([",[100,1322,1323],{"class":117},"\"0ucJJgoHiHeId5eYV4d3hneYiHiPiPc=\"",[100,1325,1326],{"class":110},"]).size; ",[100,1328,1329],{"class":317},"// 32\n",[16,1331,1332],{},"Ее можно сохранить на сервере и присылать вместе с объектом поста",[91,1334,1336],{"className":675,"code":1335,"language":677,"meta":96,"style":96},"[\n  {\n    id: '1',\n    title: 'Post title',\n    image: '/path/to/image1.png',\n    thumbhash: '0ucJJgoHiHeId5eYV4d3hneYiHiPiPc=',\n  },\n  // ...\n];\n",[23,1337,1338,1343,1348,1359,1369,1379,1389,1394,1399],{"__ignoreMap":96},[100,1339,1340],{"class":102,"line":103},[100,1341,1342],{"class":110},"[\n",[100,1344,1345],{"class":102,"line":124},[100,1346,1347],{"class":110},"  {\n",[100,1349,1350,1353,1356],{"class":102,"line":131},[100,1351,1352],{"class":110},"    id: ",[100,1354,1355],{"class":117},"'1'",[100,1357,1358],{"class":110},",\n",[100,1360,1361,1364,1367],{"class":102,"line":167},[100,1362,1363],{"class":110},"    title: ",[100,1365,1366],{"class":117},"'Post title'",[100,1368,1358],{"class":110},[100,1370,1371,1374,1377],{"class":102,"line":197},[100,1372,1373],{"class":110},"    image: ",[100,1375,1376],{"class":117},"'/path/to/image1.png'",[100,1378,1358],{"class":110},[100,1380,1381,1384,1387],{"class":102,"line":216},[100,1382,1383],{"class":110},"    thumbhash: ",[100,1385,1386],{"class":117},"'0ucJJgoHiHeId5eYV4d3hneYiHiPiPc='",[100,1388,1358],{"class":110},[100,1390,1391],{"class":102,"line":221},[100,1392,1393],{"class":110},"  },\n",[100,1395,1396],{"class":102,"line":233},[100,1397,1398],{"class":317},"  // ...\n",[100,1400,1401],{"class":102,"line":238},[100,1402,525],{"class":110},[16,1404,1405],{},"Далее на клиенте нужно преобразовать ее сначала в Uint8Array, а затем в base64 картинку",[91,1407,1409],{"className":675,"code":1408,"language":677,"meta":96,"style":96},"const thumbToImageSrc = (thumb: string) => {\n  const binString = atob(thumb);\n  const data = Uint8Array.from(binString, (m) => m.codePointAt(0));\n  const src = thumbHashToDataURL(data);\n  return src;\n};\n",[23,1410,1411,1435,1449,1486,1500,1507],{"__ignoreMap":96},[100,1412,1413,1415,1418,1420,1422,1425,1427,1429,1431,1433],{"class":102,"line":103},[100,1414,134],{"class":106},[100,1416,1417],{"class":137}," thumbToImageSrc",[100,1419,141],{"class":106},[100,1421,144],{"class":110},[100,1423,1424],{"class":147},"thumb",[100,1426,151],{"class":106},[100,1428,155],{"class":154},[100,1430,158],{"class":110},[100,1432,161],{"class":106},[100,1434,164],{"class":110},[100,1436,1437,1439,1441,1443,1446],{"class":102,"line":124},[100,1438,330],{"class":106},[100,1440,1257],{"class":154},[100,1442,141],{"class":106},[100,1444,1445],{"class":137}," atob",[100,1447,1448],{"class":110},"(thumb);\n",[100,1450,1451,1453,1456,1458,1461,1463,1466,1469,1471,1473,1476,1479,1481,1483],{"class":102,"line":131},[100,1452,330],{"class":106},[100,1454,1455],{"class":154}," data",[100,1457,141],{"class":106},[100,1459,1460],{"class":110}," Uint8Array.",[100,1462,114],{"class":137},[100,1464,1465],{"class":110},"(binString, (",[100,1467,1468],{"class":147},"m",[100,1470,158],{"class":110},[100,1472,161],{"class":106},[100,1474,1475],{"class":110}," m.",[100,1477,1478],{"class":137},"codePointAt",[100,1480,411],{"class":110},[100,1482,522],{"class":154},[100,1484,1485],{"class":110},"));\n",[100,1487,1488,1490,1492,1494,1497],{"class":102,"line":167},[100,1489,330],{"class":106},[100,1491,638],{"class":154},[100,1493,141],{"class":106},[100,1495,1496],{"class":137}," thumbHashToDataURL",[100,1498,1499],{"class":110},"(data);\n",[100,1501,1502,1504],{"class":102,"line":197},[100,1503,170],{"class":106},[100,1505,1506],{"class":110}," src;\n",[100,1508,1509],{"class":102,"line":216},[100,1510,280],{"class":110},[16,1512,1513],{},"Наконец нам нужен компонент, который будет запускать загрузку оригинальной картинки и отображать thumbhash миниатюру на время загрузки",[91,1515,1517],{"className":93,"code":1516,"language":95,"meta":96,"style":96},"type ProgressiveImageProps = {\n    src: string;\n    thumbHash: string;\n}\n\nconst ProgressiveImage: React.FC\u003CProgressiveImageProps> = ({ src: originalImageSrc, thumbHash }) => {\n  const thumb = useMemo(() => thumbHash ? thumbToImageSrc(thumbHash) : null, [thumbHash]);\n  const [imgSrc, setImgSrc] = useState(thumb ? thumb : originalImageSrc);\n\n  const loadOriginalImage = useCallback(async () => {\n    await loadImage(originalImageSrc);\n    setImgSrc(originalImageSrc);\n  }, [originalImageSrc]);\n\n  useEffect(() => {\n    if (thumbHash ) {\n      loadOriginalImage();\n    };\n  }, [loadOriginalImage, thumbHash]);\n\n  return (\n    \u003Cimg src={imgSrc} />\n  );\n};\n",[23,1518,1519,1531,1542,1553,1557,1561,1610,1646,1679,1683,1704,1714,1721,1726,1730,1741,1749,1756,1760,1765,1769,1775,1788,1792],{"__ignoreMap":96},[100,1520,1521,1524,1527,1529],{"class":102,"line":103},[100,1522,1523],{"class":106},"type",[100,1525,1526],{"class":137}," ProgressiveImageProps",[100,1528,141],{"class":106},[100,1530,164],{"class":110},[100,1532,1533,1536,1538,1540],{"class":102,"line":124},[100,1534,1535],{"class":147},"    src",[100,1537,151],{"class":106},[100,1539,155],{"class":154},[100,1541,121],{"class":110},[100,1543,1544,1547,1549,1551],{"class":102,"line":131},[100,1545,1546],{"class":147},"    thumbHash",[100,1548,151],{"class":106},[100,1550,155],{"class":154},[100,1552,121],{"class":110},[100,1554,1555],{"class":102,"line":167},[100,1556,664],{"class":110},[100,1558,1559],{"class":102,"line":197},[100,1560,128],{"emptyLinePlaceholder":127},[100,1562,1563,1565,1568,1570,1572,1574,1577,1579,1582,1585,1587,1590,1593,1596,1598,1600,1603,1606,1608],{"class":102,"line":216},[100,1564,134],{"class":106},[100,1566,1567],{"class":137}," ProgressiveImage",[100,1569,151],{"class":106},[100,1571,454],{"class":137},[100,1573,341],{"class":110},[100,1575,1576],{"class":137},"FC",[100,1578,179],{"class":110},[100,1580,1581],{"class":137},"ProgressiveImageProps",[100,1583,1584],{"class":110},"> ",[100,1586,227],{"class":106},[100,1588,1589],{"class":110}," ({ ",[100,1591,1592],{"class":147},"src",[100,1594,1595],{"class":110},": ",[100,1597,394],{"class":147},[100,1599,397],{"class":110},[100,1601,1602],{"class":147},"thumbHash",[100,1604,1605],{"class":110}," }) ",[100,1607,161],{"class":106},[100,1609,164],{"class":110},[100,1611,1612,1614,1617,1619,1622,1625,1627,1630,1633,1635,1638,1640,1643],{"class":102,"line":221},[100,1613,330],{"class":106},[100,1615,1616],{"class":154}," thumb",[100,1618,141],{"class":106},[100,1620,1621],{"class":137}," useMemo",[100,1623,1624],{"class":110},"(() ",[100,1626,161],{"class":106},[100,1628,1629],{"class":110}," thumbHash ",[100,1631,1632],{"class":106},"?",[100,1634,1417],{"class":137},[100,1636,1637],{"class":110},"(thumbHash) ",[100,1639,151],{"class":106},[100,1641,1642],{"class":154}," null",[100,1644,1645],{"class":110},", [thumbHash]);\n",[100,1647,1648,1650,1652,1655,1657,1660,1662,1664,1666,1669,1671,1674,1676],{"class":102,"line":233},[100,1649,330],{"class":106},[100,1651,391],{"class":110},[100,1653,1654],{"class":154},"imgSrc",[100,1656,397],{"class":110},[100,1658,1659],{"class":154},"setImgSrc",[100,1661,403],{"class":110},[100,1663,227],{"class":106},[100,1665,408],{"class":137},[100,1667,1668],{"class":110},"(thumb ",[100,1670,1632],{"class":106},[100,1672,1673],{"class":110}," thumb ",[100,1675,151],{"class":106},[100,1677,1678],{"class":110}," originalImageSrc);\n",[100,1680,1681],{"class":102,"line":238},[100,1682,128],{"emptyLinePlaceholder":127},[100,1684,1685,1687,1690,1692,1694,1696,1698,1700,1702],{"class":102,"line":256},[100,1686,330],{"class":106},[100,1688,1689],{"class":154}," loadOriginalImage",[100,1691,141],{"class":106},[100,1693,435],{"class":137},[100,1695,411],{"class":110},[100,1697,1022],{"class":106},[100,1699,249],{"class":110},[100,1701,161],{"class":106},[100,1703,164],{"class":110},[100,1705,1706,1709,1711],{"class":102,"line":265},[100,1707,1708],{"class":106},"    await",[100,1710,138],{"class":137},[100,1712,1713],{"class":110},"(originalImageSrc);\n",[100,1715,1716,1719],{"class":102,"line":271},[100,1717,1718],{"class":137},"    setImgSrc",[100,1720,1713],{"class":110},[100,1722,1723],{"class":102,"line":277},[100,1724,1725],{"class":110},"  }, [originalImageSrc]);\n",[100,1727,1728],{"class":102,"line":283},[100,1729,128],{"emptyLinePlaceholder":127},[100,1731,1732,1735,1737,1739],{"class":102,"line":288},[100,1733,1734],{"class":137},"  useEffect",[100,1736,1624],{"class":110},[100,1738,161],{"class":106},[100,1740,164],{"class":110},[100,1742,1743,1746],{"class":102,"line":314},[100,1744,1745],{"class":106},"    if",[100,1747,1748],{"class":110}," (thumbHash ) {\n",[100,1750,1751,1754],{"class":102,"line":321},[100,1752,1753],{"class":137},"      loadOriginalImage",[100,1755,213],{"class":110},[100,1757,1758],{"class":102,"line":327},[100,1759,268],{"class":110},[100,1761,1762],{"class":102,"line":350},[100,1763,1764],{"class":110},"  }, [loadOriginalImage, thumbHash]);\n",[100,1766,1767],{"class":102,"line":358},[100,1768,128],{"emptyLinePlaceholder":127},[100,1770,1771,1773],{"class":102,"line":363},[100,1772,170],{"class":106},[100,1774,582],{"class":110},[100,1776,1777,1779,1781,1783,1785],{"class":102,"line":368},[100,1778,588],{"class":110},[100,1780,37],{"class":591},[100,1782,638],{"class":137},[100,1784,227],{"class":106},[100,1786,1787],{"class":110},"{imgSrc} />\n",[100,1789,1790],{"class":102,"line":386},[100,1791,569],{"class":110},[100,1793,1794],{"class":102,"line":420},[100,1795,280],{"class":110},[11,1797,1799],{"id":1798},"generate-thumbhash-on-server-side","Генерация thumbhash на сервере",[16,1801,1802,1803,1810],{},"Скорее всего будет использоваться ",[71,1804,1807],{"href":1805,"rel":1806},"https://developer.mozilla.org/ru/docs/Web/API/FormData",[75],[23,1808,1809],{},"FormData",", чтобы загрузить файл на сервер.",[91,1812,1814],{"className":675,"code":1813,"language":677,"meta":96,"style":96},"export async function POST(request: NextRequest) {\n  const formData = await request.formData();\n  const file = formData.get('file') as File;\n\n  if (!file) {\n    return NextResponse.json({\n      code: 'FILE_NOT_FOUND'\n    }, {\n      status: 404\n    });\n  }\n\n  const arrayBuffer = await file.arrayBuffer();\n  const buffer = Buffer.from(arrayBuffer);\n\n  const url = await uploadFile(buffer); // save file on your server somehow\n  const thumbhash = await generateThumbhash(buffer); // We need to implement this\n\n  return NextResponse.json({\n    url,\n    thumbhash\n  });\n}\n",[23,1815,1816,1840,1859,1887,1891,1903,1917,1925,1930,1938,1943,1948,1952,1971,1988,1992,2011,2030,2034,2044,2049,2054,2058],{"__ignoreMap":96},[100,1817,1818,1820,1823,1825,1828,1830,1833,1835,1838],{"class":102,"line":103},[100,1819,371],{"class":106},[100,1821,1822],{"class":106}," async",[100,1824,377],{"class":106},[100,1826,1827],{"class":137}," POST",[100,1829,411],{"class":110},[100,1831,1832],{"class":147},"request",[100,1834,151],{"class":106},[100,1836,1837],{"class":137}," NextRequest",[100,1839,491],{"class":110},[100,1841,1842,1844,1847,1849,1851,1854,1857],{"class":102,"line":124},[100,1843,330],{"class":106},[100,1845,1846],{"class":154}," formData",[100,1848,141],{"class":106},[100,1850,537],{"class":106},[100,1852,1853],{"class":110}," request.",[100,1855,1856],{"class":137},"formData",[100,1858,213],{"class":110},[100,1860,1861,1863,1865,1867,1870,1873,1875,1878,1880,1883,1885],{"class":102,"line":131},[100,1862,330],{"class":106},[100,1864,514],{"class":154},[100,1866,141],{"class":106},[100,1868,1869],{"class":110}," formData.",[100,1871,1872],{"class":137},"get",[100,1874,411],{"class":110},[100,1876,1877],{"class":117},"'file'",[100,1879,158],{"class":110},[100,1881,1882],{"class":106},"as",[100,1884,305],{"class":137},[100,1886,121],{"class":110},[100,1888,1889],{"class":102,"line":167},[100,1890,128],{"emptyLinePlaceholder":127},[100,1892,1893,1896,1898,1900],{"class":102,"line":197},[100,1894,1895],{"class":106},"  if",[100,1897,144],{"class":110},[100,1899,482],{"class":106},[100,1901,1902],{"class":110},"file) {\n",[100,1904,1905,1908,1911,1914],{"class":102,"line":216},[100,1906,1907],{"class":106},"    return",[100,1909,1910],{"class":110}," NextResponse.",[100,1912,1913],{"class":137},"json",[100,1915,1916],{"class":110},"({\n",[100,1918,1919,1922],{"class":102,"line":221},[100,1920,1921],{"class":110},"      code: ",[100,1923,1924],{"class":117},"'FILE_NOT_FOUND'\n",[100,1926,1927],{"class":102,"line":233},[100,1928,1929],{"class":110},"    }, {\n",[100,1931,1932,1935],{"class":102,"line":238},[100,1933,1934],{"class":110},"      status: ",[100,1936,1937],{"class":154},"404\n",[100,1939,1940],{"class":102,"line":256},[100,1941,1942],{"class":110},"    });\n",[100,1944,1945],{"class":102,"line":265},[100,1946,1947],{"class":110},"  }\n",[100,1949,1950],{"class":102,"line":271},[100,1951,128],{"emptyLinePlaceholder":127},[100,1953,1954,1956,1959,1961,1963,1966,1969],{"class":102,"line":277},[100,1955,330],{"class":106},[100,1957,1958],{"class":154}," arrayBuffer",[100,1960,141],{"class":106},[100,1962,537],{"class":106},[100,1964,1965],{"class":110}," file.",[100,1967,1968],{"class":137},"arrayBuffer",[100,1970,213],{"class":110},[100,1972,1973,1975,1978,1980,1983,1985],{"class":102,"line":283},[100,1974,330],{"class":106},[100,1976,1977],{"class":154}," buffer",[100,1979,141],{"class":106},[100,1981,1982],{"class":110}," Buffer.",[100,1984,114],{"class":137},[100,1986,1987],{"class":110},"(arrayBuffer);\n",[100,1989,1990],{"class":102,"line":288},[100,1991,128],{"emptyLinePlaceholder":127},[100,1993,1994,1996,1998,2000,2002,2005,2008],{"class":102,"line":314},[100,1995,330],{"class":106},[100,1997,333],{"class":154},[100,1999,141],{"class":106},[100,2001,537],{"class":106},[100,2003,2004],{"class":137}," uploadFile",[100,2006,2007],{"class":110},"(buffer); ",[100,2009,2010],{"class":317},"// save file on your server somehow\n",[100,2012,2013,2015,2018,2020,2022,2025,2027],{"class":102,"line":321},[100,2014,330],{"class":106},[100,2016,2017],{"class":154}," thumbhash",[100,2019,141],{"class":106},[100,2021,537],{"class":106},[100,2023,2024],{"class":137}," generateThumbhash",[100,2026,2007],{"class":110},[100,2028,2029],{"class":317},"// We need to implement this\n",[100,2031,2032],{"class":102,"line":327},[100,2033,128],{"emptyLinePlaceholder":127},[100,2035,2036,2038,2040,2042],{"class":102,"line":350},[100,2037,170],{"class":106},[100,2039,1910],{"class":110},[100,2041,1913],{"class":137},[100,2043,1916],{"class":110},[100,2045,2046],{"class":102,"line":358},[100,2047,2048],{"class":110},"    url,\n",[100,2050,2051],{"class":102,"line":363},[100,2052,2053],{"class":110},"    thumbhash\n",[100,2055,2056],{"class":102,"line":368},[100,2057,274],{"class":110},[100,2059,2060],{"class":102,"line":386},[100,2061,664],{"class":110},[2063,2064,2066],"h3",{"id":2065},"generate-thumbhash-on-server-side-using-canvas","При помощи canvas",[16,2068,2069,2070],{},"Чтобы сгенерировать thumbhash, нужно считать данные изображения, только вот сервере у нас нет нативной поддержки canvas и нужно будет воспользоваться сторонней библиотекой, например ",[71,2071,2072],{"href":2072,"rel":2073},"https://www.npmjs.com/package/canvas",[75],[91,2075,2077],{"className":675,"code":2076,"language":677,"meta":96,"style":96},"import { createCanvas, loadImage } from \"canvas\";\n\nasync function loadImageAndConvertToHashWithCanvas(\n  buffer: Buffer\n) {\n  const maxSize = 100;\n  // load image\n  const image = await loadImage(buffer);\n  const width = image.width;\n  const height = image.height;\n  // calculate new size\n  const scale = Math.min(maxSize / width, maxSize / height);\n  const resizedWidth = Math.floor(width * scale);\n  const resizedHeight = Math.floor(height * scale);\n  // create thumb with new size\n  const canvas = createCanvas(resizedWidth, resizedHeight);\n  const ctx = canvas.getContext(\"2d\");\n  ctx.drawImage(image, 0, 0, resizedWidth, resizedHeight);\n  // get pixels array\n  const imageData = ctx.getImageData(0, 0, resizedWidth, resizedHeight);\n  const rgba = new Uint8Array(imageData.data.buffer);\n  // generate thumbhash\n  const hash = rgbaToThumbHash(resizedWidth, resizedHeight, rgba);\n  // convert it to base64\n  const base64 = Buffer.from(hash).toString('base64');\n  return base64;\n}\n",[23,2078,2079,2093,2097,2108,2118,2122,2136,2141,2157,2169,2181,2186,2213,2236,2256,2261,2275,2295,2314,2319,2343,2360,2365,2378,2383,2409,2416],{"__ignoreMap":96},[100,2080,2081,2083,2086,2088,2091],{"class":102,"line":103},[100,2082,107],{"class":106},[100,2084,2085],{"class":110}," { createCanvas, loadImage } ",[100,2087,114],{"class":106},[100,2089,2090],{"class":117}," \"canvas\"",[100,2092,121],{"class":110},[100,2094,2095],{"class":102,"line":124},[100,2096,128],{"emptyLinePlaceholder":127},[100,2098,2099,2101,2103,2106],{"class":102,"line":131},[100,2100,1022],{"class":106},[100,2102,377],{"class":106},[100,2104,2105],{"class":137}," loadImageAndConvertToHashWithCanvas",[100,2107,438],{"class":110},[100,2109,2110,2113,2115],{"class":102,"line":167},[100,2111,2112],{"class":147},"  buffer",[100,2114,151],{"class":106},[100,2116,2117],{"class":137}," Buffer\n",[100,2119,2120],{"class":102,"line":197},[100,2121,491],{"class":110},[100,2123,2124,2126,2129,2131,2134],{"class":102,"line":216},[100,2125,330],{"class":106},[100,2127,2128],{"class":154}," maxSize",[100,2130,141],{"class":106},[100,2132,2133],{"class":154}," 100",[100,2135,121],{"class":110},[100,2137,2138],{"class":102,"line":221},[100,2139,2140],{"class":317},"  // load image\n",[100,2142,2143,2145,2148,2150,2152,2154],{"class":102,"line":233},[100,2144,330],{"class":106},[100,2146,2147],{"class":154}," image",[100,2149,141],{"class":106},[100,2151,537],{"class":106},[100,2153,138],{"class":137},[100,2155,2156],{"class":110},"(buffer);\n",[100,2158,2159,2161,2164,2166],{"class":102,"line":238},[100,2160,330],{"class":106},[100,2162,2163],{"class":154}," width",[100,2165,141],{"class":106},[100,2167,2168],{"class":110}," image.width;\n",[100,2170,2171,2173,2176,2178],{"class":102,"line":256},[100,2172,330],{"class":106},[100,2174,2175],{"class":154}," height",[100,2177,141],{"class":106},[100,2179,2180],{"class":110}," image.height;\n",[100,2182,2183],{"class":102,"line":265},[100,2184,2185],{"class":317},"  // calculate new size\n",[100,2187,2188,2190,2193,2195,2197,2200,2203,2205,2208,2210],{"class":102,"line":271},[100,2189,330],{"class":106},[100,2191,2192],{"class":154}," scale",[100,2194,141],{"class":106},[100,2196,804],{"class":110},[100,2198,2199],{"class":137},"min",[100,2201,2202],{"class":110},"(maxSize ",[100,2204,842],{"class":106},[100,2206,2207],{"class":110}," width, maxSize ",[100,2209,842],{"class":106},[100,2211,2212],{"class":110}," height);\n",[100,2214,2215,2217,2220,2222,2224,2227,2230,2233],{"class":102,"line":277},[100,2216,330],{"class":106},[100,2218,2219],{"class":154}," resizedWidth",[100,2221,141],{"class":106},[100,2223,804],{"class":110},[100,2225,2226],{"class":137},"floor",[100,2228,2229],{"class":110},"(width ",[100,2231,2232],{"class":106},"*",[100,2234,2235],{"class":110}," scale);\n",[100,2237,2238,2240,2243,2245,2247,2249,2252,2254],{"class":102,"line":283},[100,2239,330],{"class":106},[100,2241,2242],{"class":154}," resizedHeight",[100,2244,141],{"class":106},[100,2246,804],{"class":110},[100,2248,2226],{"class":137},[100,2250,2251],{"class":110},"(height ",[100,2253,2232],{"class":106},[100,2255,2235],{"class":110},[100,2257,2258],{"class":102,"line":288},[100,2259,2260],{"class":317},"  // create thumb with new size\n",[100,2262,2263,2265,2267,2269,2272],{"class":102,"line":314},[100,2264,330],{"class":106},[100,2266,891],{"class":154},[100,2268,141],{"class":106},[100,2270,2271],{"class":137}," createCanvas",[100,2273,2274],{"class":110},"(resizedWidth, resizedHeight);\n",[100,2276,2277,2279,2282,2284,2286,2288,2290,2293],{"class":102,"line":321},[100,2278,330],{"class":106},[100,2280,2281],{"class":154}," ctx",[100,2283,141],{"class":106},[100,2285,918],{"class":110},[100,2287,921],{"class":137},[100,2289,411],{"class":110},[100,2291,2292],{"class":117},"\"2d\"",[100,2294,417],{"class":110},[100,2296,2297,2300,2302,2305,2307,2309,2311],{"class":102,"line":327},[100,2298,2299],{"class":110},"  ctx.",[100,2301,956],{"class":137},[100,2303,2304],{"class":110},"(image, ",[100,2306,522],{"class":154},[100,2308,397],{"class":110},[100,2310,522],{"class":154},[100,2312,2313],{"class":110},", resizedWidth, resizedHeight);\n",[100,2315,2316],{"class":102,"line":350},[100,2317,2318],{"class":317},"  // get pixels array\n",[100,2320,2321,2323,2326,2328,2331,2333,2335,2337,2339,2341],{"class":102,"line":358},[100,2322,330],{"class":106},[100,2324,2325],{"class":154}," imageData",[100,2327,141],{"class":106},[100,2329,2330],{"class":110}," ctx.",[100,2332,1213],{"class":137},[100,2334,411],{"class":110},[100,2336,522],{"class":154},[100,2338,397],{"class":110},[100,2340,522],{"class":154},[100,2342,2313],{"class":110},[100,2344,2345,2347,2350,2352,2354,2357],{"class":102,"line":363},[100,2346,330],{"class":106},[100,2348,2349],{"class":154}," rgba",[100,2351,141],{"class":106},[100,2353,173],{"class":106},[100,2355,2356],{"class":137}," Uint8Array",[100,2358,2359],{"class":110},"(imageData.data.buffer);\n",[100,2361,2362],{"class":102,"line":368},[100,2363,2364],{"class":317},"  // generate thumbhash\n",[100,2366,2367,2369,2371,2373,2375],{"class":102,"line":386},[100,2368,330],{"class":106},[100,2370,1236],{"class":154},[100,2372,141],{"class":106},[100,2374,1241],{"class":137},[100,2376,2377],{"class":110},"(resizedWidth, resizedHeight, rgba);\n",[100,2379,2380],{"class":102,"line":420},[100,2381,2382],{"class":317},"  // convert it to base64\n",[100,2384,2385,2387,2390,2392,2394,2396,2399,2402,2404,2407],{"class":102,"line":425},[100,2386,330],{"class":106},[100,2388,2389],{"class":154}," base64",[100,2391,141],{"class":106},[100,2393,1982],{"class":110},[100,2395,114],{"class":137},[100,2397,2398],{"class":110},"(hash).",[100,2400,2401],{"class":137},"toString",[100,2403,411],{"class":110},[100,2405,2406],{"class":117},"'base64'",[100,2408,417],{"class":110},[100,2410,2411,2413],{"class":102,"line":441},[100,2412,170],{"class":106},[100,2414,2415],{"class":110}," base64;\n",[100,2417,2418],{"class":102,"line":474},[100,2419,664],{"class":110},[2063,2421,2423],{"id":2422},"generate-thumbhash-on-server-side-using-sharp","При помощи sharp",[16,2425,2426,2427],{},"Так же можно воспользоваться библиотекой ",[23,2428,2429],{},"sharp",[91,2431,2433],{"className":675,"code":2432,"language":677,"meta":96,"style":96},"import sharp from \"sharp\";\n\nconst loadImageAndConvertToHashWithSharp = async (buffer: Buffer) => {\n  // load image\n  const sharpImage = sharp(buffer);\n  const imageMetadata = await sharpImage.metadata();\n  // calculate new size\n  const size = Math.max(imageMetadata.width || 1, imageMetadata.height || 1);\n  const w = Math.round(100 * (imageMetadata.width || 1) / size);\n  const h = Math.round(100 * (imageMetadata.height || 1) / size);\n  // create thumb with new size\n  const { data } = await sharpImage\n    .resize({\n      withoutEnlargement: true,\n      width: w,\n      height: h,\n    })\n    .ensureAlpha() // rgbaToThumbHash require 4 channals\n    .raw()\n    .toBuffer({ resolveWithObject: true });\n  // generate thumbhash\n  const hash = rgbaToThumbHash(w, h, data);\n  // convert it to base64\n  const base64 = Buffer.from(hash).toString('base64');\n  return base64;\n};\n",[23,2434,2435,2449,2453,2480,2484,2498,2517,2521,2551,2582,2613,2617,2637,2647,2657,2662,2667,2672,2685,2695,2710,2714,2727,2731,2753,2759],{"__ignoreMap":96},[100,2436,2437,2439,2442,2444,2447],{"class":102,"line":103},[100,2438,107],{"class":106},[100,2440,2441],{"class":110}," sharp ",[100,2443,114],{"class":106},[100,2445,2446],{"class":117}," \"sharp\"",[100,2448,121],{"class":110},[100,2450,2451],{"class":102,"line":124},[100,2452,128],{"emptyLinePlaceholder":127},[100,2454,2455,2457,2460,2462,2464,2466,2469,2471,2474,2476,2478],{"class":102,"line":131},[100,2456,134],{"class":106},[100,2458,2459],{"class":137}," loadImageAndConvertToHashWithSharp",[100,2461,141],{"class":106},[100,2463,1822],{"class":106},[100,2465,144],{"class":110},[100,2467,2468],{"class":147},"buffer",[100,2470,151],{"class":106},[100,2472,2473],{"class":137}," Buffer",[100,2475,158],{"class":110},[100,2477,161],{"class":106},[100,2479,164],{"class":110},[100,2481,2482],{"class":102,"line":167},[100,2483,2140],{"class":317},[100,2485,2486,2488,2491,2493,2496],{"class":102,"line":197},[100,2487,330],{"class":106},[100,2489,2490],{"class":154}," sharpImage",[100,2492,141],{"class":106},[100,2494,2495],{"class":137}," sharp",[100,2497,2156],{"class":110},[100,2499,2500,2502,2505,2507,2509,2512,2515],{"class":102,"line":216},[100,2501,330],{"class":106},[100,2503,2504],{"class":154}," imageMetadata",[100,2506,141],{"class":106},[100,2508,537],{"class":106},[100,2510,2511],{"class":110}," sharpImage.",[100,2513,2514],{"class":137},"metadata",[100,2516,213],{"class":110},[100,2518,2519],{"class":102,"line":221},[100,2520,2185],{"class":317},[100,2522,2523,2525,2527,2529,2531,2533,2536,2539,2542,2545,2547,2549],{"class":102,"line":233},[100,2524,330],{"class":106},[100,2526,799],{"class":154},[100,2528,141],{"class":106},[100,2530,804],{"class":110},[100,2532,807],{"class":137},[100,2534,2535],{"class":110},"(imageMetadata.width ",[100,2537,2538],{"class":106},"||",[100,2540,2541],{"class":154}," 1",[100,2543,2544],{"class":110},", imageMetadata.height ",[100,2546,2538],{"class":106},[100,2548,2541],{"class":154},[100,2550,417],{"class":110},[100,2552,2553,2555,2557,2559,2561,2563,2565,2567,2569,2572,2574,2576,2578,2580],{"class":102,"line":238},[100,2554,330],{"class":106},[100,2556,817],{"class":154},[100,2558,141],{"class":106},[100,2560,804],{"class":110},[100,2562,829],{"class":137},[100,2564,411],{"class":110},[100,2566,834],{"class":154},[100,2568,837],{"class":106},[100,2570,2571],{"class":110}," (imageMetadata.width ",[100,2573,2538],{"class":106},[100,2575,2541],{"class":154},[100,2577,158],{"class":110},[100,2579,842],{"class":106},[100,2581,845],{"class":110},[100,2583,2584,2586,2588,2590,2592,2594,2596,2598,2600,2603,2605,2607,2609,2611],{"class":102,"line":256},[100,2585,330],{"class":106},[100,2587,852],{"class":154},[100,2589,141],{"class":106},[100,2591,804],{"class":110},[100,2593,829],{"class":137},[100,2595,411],{"class":110},[100,2597,834],{"class":154},[100,2599,837],{"class":106},[100,2601,2602],{"class":110}," (imageMetadata.height ",[100,2604,2538],{"class":106},[100,2606,2541],{"class":154},[100,2608,158],{"class":110},[100,2610,842],{"class":106},[100,2612,845],{"class":110},[100,2614,2615],{"class":102,"line":265},[100,2616,2260],{"class":317},[100,2618,2619,2621,2624,2627,2630,2632,2634],{"class":102,"line":271},[100,2620,330],{"class":106},[100,2622,2623],{"class":110}," { ",[100,2625,2626],{"class":154},"data",[100,2628,2629],{"class":110}," } ",[100,2631,227],{"class":106},[100,2633,537],{"class":106},[100,2635,2636],{"class":110}," sharpImage\n",[100,2638,2639,2642,2645],{"class":102,"line":277},[100,2640,2641],{"class":110},"    .",[100,2643,2644],{"class":137},"resize",[100,2646,1916],{"class":110},[100,2648,2649,2652,2655],{"class":102,"line":283},[100,2650,2651],{"class":110},"      withoutEnlargement: ",[100,2653,2654],{"class":154},"true",[100,2656,1358],{"class":110},[100,2658,2659],{"class":102,"line":288},[100,2660,2661],{"class":110},"      width: w,\n",[100,2663,2664],{"class":102,"line":314},[100,2665,2666],{"class":110},"      height: h,\n",[100,2668,2669],{"class":102,"line":321},[100,2670,2671],{"class":110},"    })\n",[100,2673,2674,2676,2679,2682],{"class":102,"line":327},[100,2675,2641],{"class":110},[100,2677,2678],{"class":137},"ensureAlpha",[100,2680,2681],{"class":110},"() ",[100,2683,2684],{"class":317},"// rgbaToThumbHash require 4 channals\n",[100,2686,2687,2689,2692],{"class":102,"line":350},[100,2688,2641],{"class":110},[100,2690,2691],{"class":137},"raw",[100,2693,2694],{"class":110},"()\n",[100,2696,2697,2699,2702,2705,2707],{"class":102,"line":358},[100,2698,2641],{"class":110},[100,2700,2701],{"class":137},"toBuffer",[100,2703,2704],{"class":110},"({ resolveWithObject: ",[100,2706,2654],{"class":154},[100,2708,2709],{"class":110}," });\n",[100,2711,2712],{"class":102,"line":363},[100,2713,2364],{"class":317},[100,2715,2716,2718,2720,2722,2724],{"class":102,"line":368},[100,2717,330],{"class":106},[100,2719,1236],{"class":154},[100,2721,141],{"class":106},[100,2723,1241],{"class":137},[100,2725,2726],{"class":110},"(w, h, data);\n",[100,2728,2729],{"class":102,"line":386},[100,2730,2382],{"class":317},[100,2732,2733,2735,2737,2739,2741,2743,2745,2747,2749,2751],{"class":102,"line":420},[100,2734,330],{"class":106},[100,2736,2389],{"class":154},[100,2738,141],{"class":106},[100,2740,1982],{"class":110},[100,2742,114],{"class":137},[100,2744,2398],{"class":110},[100,2746,2401],{"class":137},[100,2748,411],{"class":110},[100,2750,2406],{"class":117},[100,2752,417],{"class":110},[100,2754,2755,2757],{"class":102,"line":425},[100,2756,170],{"class":106},[100,2758,2415],{"class":110},[100,2760,2761],{"class":102,"line":441},[100,2762,280],{"class":110},[2764,2765,2766],"style",{},"html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html pre.shiki code .szBVR, html code.shiki .szBVR{--shiki-default:#D73A49;--shiki-dark:#F97583}html pre.shiki code .sVt8B, html code.shiki .sVt8B{--shiki-default:#24292E;--shiki-dark:#E1E4E8}html pre.shiki code .sZZnC, html code.shiki .sZZnC{--shiki-default:#032F62;--shiki-dark:#9ECBFF}html pre.shiki code .sScJk, html code.shiki .sScJk{--shiki-default:#6F42C1;--shiki-dark:#B392F0}html pre.shiki code .s4XuR, html code.shiki .s4XuR{--shiki-default:#E36209;--shiki-dark:#FFAB70}html pre.shiki code .sj4cs, html code.shiki .sj4cs{--shiki-default:#005CC5;--shiki-dark:#79B8FF}html pre.shiki code .sJ8bj, html code.shiki .sJ8bj{--shiki-default:#6A737D;--shiki-dark:#6A737D}html pre.shiki code .s9eBZ, html code.shiki .s9eBZ{--shiki-default:#22863A;--shiki-dark:#85E89D}",{"title":96,"searchDepth":124,"depth":124,"links":2768},[2769,2770,2771],{"id":13,"depth":124,"text":14},{"id":78,"depth":124,"text":79},{"id":1798,"depth":124,"text":1799,"children":2772},[2773,2774],{"id":2065,"depth":131,"text":2066},{"id":2422,"depth":131,"text":2423},"2024-01-22","Прогрессивная загрузка изображений при помощи создания миниатюр в thumbhash и их использование в React","md",{},"/blog/progressive-images-using-thumbhash","/images/image-thumb-preview.webp",{"title":6,"description":2776},"blog/progressive-images-using-thumbhash",[2784,2785,2786],"images","react","node.js","3LPPKEE8XZT4UIR2vkmVIVrk9_jr5rlo_-Di3FuX-KE",1751114697591]